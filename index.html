
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>中国皇帝时间轴（短年号也能放大显示）</title>
<style>
:root{--border:#e5e7eb;--gridv:#eef2f7;--gridh:#f8fafc;--axis:#9ca3af}
*{box-sizing:border-box}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
h1{margin:16px auto 0;max-width:1280px;padding:0 16px;font-size:26px}
.card{max-width:1280px;margin:12px auto;background:#fff;border:1px solid var(--border);border-radius:14px;padding:12px 16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
select,input[type=number]{padding:8px 10px;border:1px solid var(--border);border-radius:10px}
input[type=range]{width:260px}
.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#111827;color:#fff;cursor:pointer}
.btn.s{background:#fff;color:#111827}
.small{font-size:12px;color:#6b7280}
.timeline{display:grid;grid-template-columns:280px 1fr}
.left{position:sticky;left:0;background:#fff;border-right:1px solid var(--border);z-index:3}
svg{display:block}
.label{fill:#1f2937;font-size:12px}
.group{fill:#111827;font-weight:700;font-size:13px}
.axis text{fill:var(--axis);font-size:12px}
.axis line{stroke:var(--axis)}
.gridv{stroke:var(--gridv)}
.gridh{stroke:var(--gridh)}
.tip{position:fixed;display:none;background:#111827;color:#fff;border-radius:8px;font-size:12px;padding:6px 8px;pointer-events:none;z-index:10}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#f3f4f6;border:1.5px solid #e5e7eb;cursor:pointer}
.chip.active{border-color:#111827}
.chip .dot{width:10px;height:10px;border-radius:50%}
</style>
</head>
<body>
<h1>中国皇帝时间轴</h1>

<section class="card">
  <div class="row">
    <select id="dyn"><option>加载中…</option></select>
    <button class="btn" id="add">添加朝代</button>
    <button class="btn s" id="clear">清空</button>
    <span class="small">缩放</span><input id="zoom" type="range" min="1" max="12" step="0.1" value="1"><span id="zv" class="small">1.0×</span>
    <label class="small"><input id="grid" type="checkbox" checked> 显示网格</label>
  </div>
  <div class="chips" id="chips"></div>
</section>

<section class="card" id="panel" style="display:none">
  <div class="timeline">
    <svg id="left"></svg>
    <div style="overflow:auto">
      <svg id="main"></svg>
    </div>
  </div>
</section>

<div class="tip" id="tip"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
(() => {
const XLSX_URL='emperors.xlsx';
const PALETTE=["#8b5cf6","#60a5fa","#22c55e","#f59e0b","#ef4444","#06b6d4","#a3e635","#d946ef","#10b981","#eab308","#3b82f6","#14b8a6","#f43f5e","#0ea5e9","#84cc16","#6366f1"];
const lighten=(h,p=0.55)=>{try{let c=h.slice(1);if(c.length===3)c=[...c].map(x=>x+x).join('');let r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16);r=Math.round(r+(255-r)*p);g=Math.round(g+(255-g)*p);b=Math.round(b+(255-b)*p);return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`}catch(e){return h}};
const darken=(h,a=-40)=>{try{let c=h.slice(1);if(c.length===3)c=[...c].map(x=>x+x).join('');let r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16);r=Math.max(0,Math.min(255,r+a));g=Math.max(0,Math.min(255,g+a));b=Math.max(0,Math.min(255,b+a));return `#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`}catch(e){return h}};
const twoCharPx=(()=>{try{const c=document.createElement('canvas');const ctx=c.getContext('2d');ctx.font='12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans';return Math.ceil(ctx.measureText('汉字').width)}catch(e){return 28}})();

const $=q=>document.querySelector(q);
let rows=[], eras=[], ranges={}, allDyn={}, picked=[], colorsEmp={}, colorsEra={};
let zoom=1;

function parsePiece(s){let m=String(s||'').trim().match(/^(-?\d+)(?:\.(\d{1,2}))?$/); if(!m) return [null,null]; return [parseInt(m[1],10), m[2]?parseInt(m[2],10):null]}
const startF=(y,m)=>y==null?null:y+(y<0?-1:1)*((m?m:1)-1)/12;
const endF=(y,m)=>y==null?null:y+(y<0?-1:1)*(m?m:12)/12;

function load(){
  fetch(XLSX_URL,{cache:'no-store'}).then(r=>r.arrayBuffer()).then(buf=>{
    const wb=XLSX.read(buf,{type:'array'});
    rows=[]; ranges={}; allDyn={};
    wb.SheetNames.forEach(sn=>{
      if(sn==='年号'||/^nianhao$/i.test(sn)) return;
      const ws=wb.Sheets[sn]; if(!ws) return;
      const json=XLSX.utils.sheet_to_json(ws,{raw:true,defval:''});
      json.forEach(r=>{
        const [sy,sm]=parsePiece(r['在位起']); const [ey,em]=parsePiece(r['在位止']);
        const s=startF(sy,sm), e=endF(ey,em);
        if(r['朝代'] && r['姓名'] && s!=null && e!=null){
          rows.push({dyn:r['朝代'], name:r['姓名'], alias:r['常用称呼']||r['姓名'], s,e, sy,sm,ey,em});
          allDyn[r['朝代']]=1;
          if(!ranges[r['朝代']]) ranges[r['朝代']]={s,e}; else {ranges[r['朝代']].s=Math.min(ranges[r['朝代']].s,s); ranges[r['朝代']].e=Math.max(ranges[r['朝代']].e,e);}
        }
      });
    });
    const wsEra = wb.Sheets['年号']||wb.Sheets['nianhao'];
    if(wsEra){
      eras = XLSX.utils.sheet_to_json(wsEra,{raw:true,defval:''}).map(r=>({dyn:String(r['朝代']||'').trim(), name:String(r['年号']||'').trim(), emp:String(r['姓名']||'').trim(), s:+r['公元起'], e:+r['公元止']})).filter(x=>x.dyn&&x.name&&x.emp&&isFinite(x.s)&&isFinite(x.e));
    }
    const sel=$('#dyn'); sel.innerHTML='<option value="">选择一个朝代</option>';
    Object.keys(allDyn).sort((a,b)=>ranges[a].s-ranges[b].s).forEach((d,i)=>{
      const o=document.createElement('option');o.value=d;o.textContent=d;sel.appendChild(o);
    });
  });
}

function addDyn(){
  const v=$('#dyn').value; if(!v || picked.includes(v)) return;
  const used = new Set(picked.map(d=>colorsEmp[d]||'#000'));
  const palette = PALETTE;
  const pickColor = palette.find(c=>!used.has(c)) || palette[picked.length % palette.length];
  colorsEmp[v]=pickColor; colorsEra[v]=lighten(pickColor,0.55);
  picked.push(v); renderChips(); draw();
}
function renderChips(){
  const wrap=$('#chips'); wrap.innerHTML='';
  picked.forEach(d=>{
    const s=document.createElement('span'); s.className='chip';
    s.innerHTML=`<span class="dot" style="background:${colorsEmp[d]}"></span>${d}（${Math.trunc(ranges[d].s)}—${Math.trunc(ranges[d].e)}）`;
    s.onclick=()=>{ picked=picked.filter(x=>x!==d); renderChips(); draw(); };
    wrap.appendChild(s);
  });
}

function draw(){
  if(!picked.length){ $('#panel').style.display='none'; return; }
  const list = rows.filter(r=>picked.includes(r.dyn)).sort((a,b)=>a.s-b.s);
  const L = Math.min(...list.map(r=>r.s)), R = Math.max(...list.map(r=>r.e));
  const leftW=280, rowH=32, gap=10, head=20, margin=40;
  const contentW = Math.max(1200, document.querySelector('#panel').clientWidth- leftW) * zoom + margin*2;
  const H = head + list.length*(rowH+gap) + 60;
  const scale = y => margin + ( (y-L)/(R-L || 1) )*(contentW-2*margin);
  const pxPerYear = (contentW-2*margin)/((R-L)||1);

  const left=$('#left'); const main=$('#main');
  left.setAttribute('width',leftW); left.setAttribute('height',H); left.innerHTML='';
  main.setAttribute('width',contentW); main.setAttribute('height',H); main.innerHTML='';
  const gridOn = $('#grid').checked;

  // 纵向网格
  if(gridOn){
    const step = Math.max(1, 6 - Math.floor(Math.log2(zoom+1)));
    let t = Math.ceil(L/step)*step;
    for(;t<=R;t+=step){
      const x=scale(t);
      const ln=document.createElementNS('http://www.w3.org/2000/svg','line');
      ln.setAttribute('x1',x);ln.setAttribute('x2',x);ln.setAttribute('y1',head);ln.setAttribute('y2',H-36);ln.setAttribute('class','gridv');
      ln.setAttribute('stroke-width','1'); ln.setAttribute('stroke','#eef2f7'); main.appendChild(ln);
    }
  }

  const tip=$('#tip');
  const showTip=(ev,html)=>{tip.style.display='block'; tip.style.left=(ev.clientX+12)+'px'; tip.style.top=(ev.clientY+12)+'px'; tip.innerHTML=html;}
  const hideTip=()=>tip.style.display='none';

  list.forEach((r,i)=>{
    const y = head + i*(rowH+gap);
    const xs=scale(r.s), xe=scale(r.e);
    const x1=Math.min(xs,xe), x2=Math.max(xs,xe);
    const w=Math.max(40,x2-x1), cx=(x1+x2)/2, ex1=cx-w/2, ex2=cx+w/2;

    // 左侧文字
    const t=document.createElementNS('http://www.w3.org/2000/svg','text');
    t.setAttribute('x',leftW-8); t.setAttribute('y',y+rowH*0.68); t.setAttribute('class','label'); t.setAttribute('text-anchor','end');
    t.textContent=`${r.alias}（${r.sy}—${r.ey}）`; left.appendChild(t);

    // 皇帝块
    const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x',ex1); rect.setAttribute('y',y); rect.setAttribute('width',w); rect.setAttribute('height',rowH); rect.setAttribute('rx',8);
    rect.setAttribute('fill',colorsEmp[r.dyn]||'#8b5cf6'); main.appendChild(rect);
    rect.addEventListener('mousemove',e=>showTip(e,`<b>${r.alias}</b>：${r.sy} — ${r.ey}`));
    rect.addEventListener('mouseleave',hideTip);

    // 年号（核心：短年号也显示）
    const mine = eras.filter(er=>er.dyn===r.dyn && er.emp===r.name && er.e>=r.s && er.s<=r.e).sort((a,b)=>a.s-b.s);
    const pad=3, innerL=ex1+pad, innerR=ex2-pad;
    const gapPx=3;
    // 关键：为每个年号设置“最小像素宽”，随 zoom 线性增大；zoom=1 -> 6px；zoom=12 -> 28px
    const minEraPx = Math.round(6 + (zoom-1)*(22/11));
    const items = mine.map(er=>{
      const s=Math.max(er.s,r.s), e=Math.min(er.e,r.e);
      const rawW = Math.max(1, (e-s)*pxPerYear); // 数据宽
      return {er,s,e,rawW};
    });
    // 初始宽度：至少 minEraPx
    let widths = items.map(it=>Math.max(it.rawW, minEraPx));
    // 如放不下：整体按比例压缩，但压缩后仍不小于 2px
    const avail = Math.max(0, innerR - innerL) - gapPx*(items.length?items.length-1:0);
    let sum = widths.reduce((a,b)=>a+b,0);
    if (sum > avail && items.length){
      const fac = Math.max(0.1, avail / sum);
      widths = widths.map(w=>Math.max(2, w*fac));
      // 若还是超：均分最小可行宽
      sum = widths.reduce((a,b)=>a+b,0);
      if (sum > avail){
        const wfit = Math.max(2, avail / items.length);
        widths = widths.map(_=>wfit);
      }
    }
    // 顺序排布，绝不重叠
    let cursor = innerL;
    items.forEach((it,idx)=>{
      const wEra = Math.max(2, Math.min(widths[idx], innerR - cursor));
      const sx = cursor, ex = sx + wEra; cursor = ex + gapPx;

      const eRect=document.createElementNS('http://www.w3.org/2000/svg','rect');
      eRect.setAttribute('x',sx); eRect.setAttribute('y',y+5); eRect.setAttribute('width',wEra); eRect.setAttribute('height',rowH-10); eRect.setAttribute('rx',6);
      const fill=colorsEra[r.dyn]||'#e9d5ff'; eRect.setAttribute('fill',fill); eRect.setAttribute('stroke',darken(fill,-40)); eRect.setAttribute('stroke-width','1');
      eRect.addEventListener('mousemove',e=>showTip(e,`<b>${it.er.name}</b>：${it.s} — ${it.e}`));
      eRect.addEventListener('mouseleave',hideTip);
      main.appendChild(eRect);
      // 文本：只要宽度 >= 两字宽 就显示
      if (wEra >= twoCharPx){
        const tt=document.createElementNS('http://www.w3.org/2000/svg','text');
        tt.setAttribute('x',sx+wEra/2); tt.setAttribute('y',y+5+(rowH-10)*0.68); tt.setAttribute('text-anchor','middle'); tt.setAttribute('class','label');
        tt.textContent=it.er.name; main.appendChild(tt);
      }
    });
  });

  // X轴
  const axisY=H-30;
  const ax=document.createElementNS('http://www.w3.org/2000/svg','line');
  ax.setAttribute('x1',0);ax.setAttribute('x2',contentW);ax.setAttribute('y1',axisY);ax.setAttribute('y2',axisY);ax.setAttribute('class','axis');main.appendChild(ax);
  const step = Math.max(1, 6 - Math.floor(Math.log2(zoom+1)));
  let t = Math.ceil(L/step)*step;
  for(;t<=R;t+=step){
    const x=scale(t);
    const ln=document.createElementNS('http://www.w3.org/2000/svg','line'); ln.setAttribute('x1',x); ln.setAttribute('x2',x); ln.setAttribute('y1',axisY); ln.setAttribute('y2',axisY+6); ln.setAttribute('class','axis'); main.appendChild(ln);
    const tx=document.createElementNS('http://www.w3.org/2000/svg','text'); tx.setAttribute('x',x); tx.setAttribute('y',axisY+18); tx.setAttribute('text-anchor','middle'); tx.setAttribute('class','axis'); tx.textContent=t; main.appendChild(tx);
  }

  $('#panel').style.display='';
}

$('#add').onclick=addDyn;
$('#dyn').onchange=()=>{};
$('#clear').onclick=()=>{picked=[];renderChips();draw()};
$('#zoom').oninput=e=>{zoom=parseFloat(e.target.value)||1; $('#zv').textContent=zoom.toFixed(1)+'×'; draw()};
$('#grid').onchange=draw;

load();
})();
</script>
</body>
</html>
