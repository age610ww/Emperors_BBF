<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>中国皇帝时间轴</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --chip-bg: #f3f4f6;
      --chip-border: #e5e7eb;
      --axis: #9ca3af;
      --group: #1f2937;
      --accent: #2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans;}
    header{padding:24px 16px 0; max-width:1200px; margin:0 auto;}
    h1{margin:0 0 8px; font-size:28px;}
    .card{max-width:1200px;margin:16px auto;background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;}
    select,input[type=number]{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text);}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#111827;color:#fff;font-weight:600;cursor:pointer;}
    .btn.secondary{background:transparent;color:var(--text);}
    .status{margin-top:6px;color:var(--muted);font-size:13px;}
    .chips{display:flex;flex-wrap:wrap;gap:8px; user-select:none;}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip-bg);border:1px solid var(--chip-border);}
    .chip .dot{width:10px;height:10px;border-radius:999px;display:inline-block;}
    .chip .rm{cursor:pointer;border:none;background:transparent;color:var(--accent);font-weight:700;}
    #timeline-wrap{width:100%;overflow-x:auto;}
    svg{width:100%;height:auto;display:block;background:#fff;}
    .axis text{fill:var(--axis);font-size:12px;}
    .axis line{stroke:var(--axis);}
    .label { fill: var(--group); font-size:12px; }
    .bar-outline{ stroke:rgba(0,0,0,.15); stroke-width:.4; fill:none; }
    .group-title{ fill:var(--group); font-size:13px; font-weight:700; }
    .band{ fill: #f9fafb; }
    .tooltip{ position: fixed; pointer-events:none; z-index: 10; background:#111827; color:#fff; padding:6px 8px; border-radius:8px; font-size:12px; box-shadow:0 6px 18px rgba(0,0,0,.15); transform: translate(-50%, -120%); opacity:0; transition: opacity .12s ease; white-space:nowrap; }
    .tooltip.show{ opacity:1; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header><h1>中国皇帝时间轴</h1></header>

<section class="card">
  <div class="row" style="align-items:flex-start; gap:16px;">
    <div style="display:flex; flex-direction:column; gap:8px;">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <select id="dynSelect" style="min-width:260px;"><option value="">加载中…</option></select>
        <button class="btn" id="btnAdd">添加朝代</button>
        <button class="btn secondary" id="btnClear">清空</button>
      </div>
      <div class="chips" id="chips" aria-label="已选择的朝代（按从古到今排序）"></div>
      <div class="status" id="status">正在加载数据…</div>
    </div>
    <div style="display:flex; flex-direction:column; gap:8px;">
      <div class="status">筛选时间段（支持负数，例：-221 到 220）</div>
      <div class="row" style="gap:8px;">
        <input id="startYear" type="number" placeholder="起始年" style="width:140px;">
        <span class="status">到</span>
        <input id="endYear" type="number" placeholder="截止年" style="width:140px;">
        <button class="btn" id="btnApplyRange">应用</button>
        <button class="btn secondary" id="btnClearRange">清除</button>
      </div>
    </div>
  </div>
</section>

<section class="card" id="result" style="display:none">
  <div id="timeline-wrap"><svg id="timeline"></svg></div>
</section>

<div id="tooltip" class="tooltip"></div>

<script>
const XLSX_URL = 'emperors.xlsx';
const S=(q,e=document)=>e.querySelector(q);
function parseNum(v){if(v==null||v==='')return null;const s=String(v).trim();if(/^公元?前/.test(s)||/^前/.test(s))return-Number(s.replace(/[^-0-9.]/g,''));if(/BCE/i.test(s))return-Number(s.replace(/[^-0-9.]/g,''));const n=Number(s.replace(/[^-0-9.]/g,''));return isNaN(n)?null:n;}
function yearLabel(y){if(y==null)return'';return y<0?`公元前${-y}年`:`公元${y}年`;}
function hashColor(str){let h=0;for(let i=0;i<str.length;i++)h=(h*31+str.charCodeAt(i))>>>0;const hue=h%360;const sat=60+(h%20);return`hsl(${hue} ${sat}% 48%)`;}
function niceStep(range){const raw=range/8;const p=Math.pow(10,Math.floor(Math.log10(raw)));const cs=[1,2,5,10].map(k=>k*p);let b=cs[0];for(const c of cs)if(Math.abs(raw-c)<Math.abs(raw-b))b=c;return Math.max(1,Math.round(b));}
function clamp(n,lo,hi){return Math.max(lo,Math.min(hi,n));}

let rows=[],dynSet=new Set(),pickedDynasties=[],customStart=null,customEnd=null;
const dynRangeMap=new Map(); // dynasty -> {start,end}

async function loadData(){
  try{
    const resp=await fetch(XLSX_URL);if(!resp.ok)throw new Error('无法加载 emperors.xlsx');const buf=await resp.arrayBuffer();const wb=XLSX.read(buf,{type:'array'});
    rows=[];wb.SheetNames.forEach(sn=>{const ws=wb.Sheets[sn];if(!ws)return;const json=XLSX.utils.sheet_to_json(ws,{raw:true,defval:''});json.forEach(r=>{const rec={朝代:r['朝代']??'',姓名:r['姓名']??'',常用称呼:r['常用称呼']??'',在位起:parseNum(r['在位起']),在位止:parseNum(r['在位止']),sheet:sn};if(rec.朝代&&rec.姓名)rows.push(rec);});});
    // build dynasty range map
    const byDyn=new Map();
    rows.forEach(r=>{
      if(r.在位起==null||r.在位止==null) return;
      if(!byDyn.has(r.朝代)) byDyn.set(r.朝代,{min:r.在位起,max:r.在位止});
      const o=byDyn.get(r.朝代); o.min=Math.min(o.min,r.在位起); o.max=Math.max(o.max,r.在位止);
    });
    byDyn.forEach((v,k)=> dynRangeMap.set(k,{start:v.min,end:v.max}));
    rows.forEach(r=>dynSet.add(r.朝代));
    const sel=S('#dynSelect');sel.innerHTML='<option value="">选择一个朝代</option>';
    [...dynSet].sort((a,b)=>{
      const ra=dynRangeMap.get(a), rb=dynRangeMap.get(b);
      const sa=ra?ra.start:Infinity, sb=rb?rb.start:Infinity;
      return sa-sb;
    }).forEach(d=>{const o=document.createElement('option');o.value=d;o.textContent=d;sel.appendChild(o);});
    S('#status').textContent='加载完成';
  }catch(e){S('#status').textContent='加载失败：'+e.message;}
}
function addDyn(){
  const v=S('#dynSelect').value;
  if(!v || pickedDynasties.includes(v)) return;
  pickedDynasties.push(v);
  // auto sort by dynasty start year
  pickedDynasties.sort((a,b)=>{
    const ra=dynRangeMap.get(a), rb=dynRangeMap.get(b);
    const sa=ra?ra.start:Infinity, sb=rb?rb.start:Infinity;
    return sa-sb;
  });
  renderChips(); draw();
}
function removeDyn(v){ pickedDynasties=pickedDynasties.filter(x=>x!==v); renderChips(); draw(); }

function renderChips(){
  const wrap=S('#chips'); wrap.innerHTML='';
  pickedDynasties.forEach(d=>{
    const chip=document.createElement('span'); chip.className='chip';
    chip.innerHTML=`<span class='dot' style='background:${hashColor(d)}'></span>${d}<button class='rm' title='移除'>×</button>`;
    chip.querySelector('.rm').onclick=()=>removeDyn(d);
    wrap.appendChild(chip);
  });
}
function applyRange(){customStart=S('#startYear').value?Number(S('#startYear').value):null;customEnd=S('#endYear').value?Number(S('#endYear').value):null;if(customStart!=null&&customEnd!=null&&customStart>customEnd)[customStart,customEnd]=[customEnd,customStart];draw();}
function clearRange(){customStart=customEnd=null;S('#startYear').value='';S('#endYear').value='';draw();}

const tip=S('#tooltip');
function showTip(html, x, y){ tip.innerHTML=html; tip.style.left=x+'px'; tip.style.top=y+'px'; tip.classList.add('show'); }
function hideTip(){ tip.classList.remove('show'); }

function draw(){
  const list=rows.filter(r=>pickedDynasties.includes(r.朝代));if(!list.length){S('#result').style.display='none';return;}
  const groups={};list.forEach(r=>{if(r.在位起==null||r.在位止==null)return;if(customStart!=null&&r.在位止<customStart)return;if(customEnd!=null&&r.在位起>customEnd)return;(groups[r.朝代]??=[]).push(r);});
  const dyns=pickedDynasties.filter(d=>groups[d]);if(!dyns.length){S('#result').style.display='none';return;}
  dyns.forEach(d=>groups[d].sort((a,b)=>a.在位起-b.在位起));const all=dyns.flatMap(d=>groups[d]);
  let minYear=Math.min(...all.map(r=>r.在位起));let maxYear=Math.max(...all.map(r=>r.在位止));
  if(customStart!=null)minYear=Math.max(minYear,customStart);if(customEnd!=null)maxYear=Math.min(maxYear,customEnd);
  const range=Math.max(1,maxYear-minYear);
  const wrap=S('#timeline-wrap');const W=Math.max(1100,wrap.clientWidth-2);
  const leftPad=200,rightPad=24,topPad=24,rowH=28,gap=8,groupGap=18;
  let rowsCount=0;dyns.forEach(d=>rowsCount+=groups[d].length);
  const H=topPad+dyns.length*24+rowsCount*(rowH+gap)+(dyns.length-1)*groupGap+80;
  const scale=y=>leftPad+((y-minYear)/range)*(W-leftPad-rightPad);
  const svg=S('#timeline');svg.setAttribute('width',W);svg.setAttribute('height',H);svg.innerHTML='';
  let cursorY=topPad;
  dyns.forEach(d=>{
    const headerH=22;
    // dynasty header with range
    const title=document.createElementNS('http://www.w3.org/2000/svg','text');
    title.setAttribute('x',12);title.setAttribute('y',cursorY+10);title.setAttribute('class','group-title');
    const r=dynRangeMap.get(d); const rangeTxt = r?`（${r.start<0?`前${-r.start}`:r.start} — ${r.end<0?`前${-r.end}`:r.end}）`:'';
    title.textContent=d + (rangeTxt?` ${rangeTxt}`:'');
    svg.appendChild(title);
    cursorY+=headerH;
    groups[d].forEach((r,i)=>{
      const y=cursorY+i*(rowH+gap);
      const s=customStart!=null?Math.max(r.在位起,customStart):r.在位起;
      const e=customEnd!=null?Math.min(r.在位止,customEnd):r.在位止;
      const x1=scale(s),x2=scale(e);
      const t=document.createElementNS('http://www.w3.org/2000/svg','text');
      t.setAttribute('x',leftPad-10);t.setAttribute('y',y+rowH*0.7);t.setAttribute('text-anchor','end');t.setAttribute('class','label');
      const alias=r.常用称呼||r.姓名; t.textContent=alias===r.姓名?alias:`${alias} ${r.姓名}`; svg.appendChild(t);
      const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x',Math.min(x1,x2));rect.setAttribute('y',y);rect.setAttribute('width',Math.max(4,Math.abs(x2-x1)));rect.setAttribute('height',rowH);
      rect.setAttribute('rx',6);rect.setAttribute('fill',hashColor(d));
      rect.addEventListener('mousemove', (ev)=>{
        showTip(`${alias===r.姓名?alias:`${alias} ${r.姓名}`}<br>${yearLabel(r.在位起)} — ${yearLabel(r.在位止)}`, ev.clientX, ev.clientY);
      });
      rect.addEventListener('mouseleave', hideTip);
      svg.appendChild(rect);
      const outline=document.createElementNS('http://www.w3.org/2000/svg','rect');
      outline.setAttribute('x',Math.min(x1,x2));outline.setAttribute('y',y);
      outline.setAttribute('width',Math.max(4,Math.abs(x2-x1)));outline.setAttribute('height',rowH);
      outline.setAttribute('rx',6);outline.setAttribute('class','bar-outline');svg.appendChild(outline);
    });
    cursorY+=groups[d].length*(rowH+gap)+groupGap;
  });
  // year axis
  const axisY=H-40;
  const line=document.createElementNS('http://www.w3.org/2000/svg','line');
  line.setAttribute('x1',leftPad);line.setAttribute('x2',W-rightPad);line.setAttribute('y1',axisY);line.setAttribute('y2',axisY);line.setAttribute('class','axis');svg.appendChild(line);
  const step=niceStep(range);
  const startTick=Math.ceil(minYear/step)*step;
  for(let t=startTick;t<=maxYear;t+=step){
    const x=scale(t);
    const tick=document.createElementNS('http://www.w3.org/2000/svg','line');
    tick.setAttribute('x1',x);tick.setAttribute('x2',x);tick.setAttribute('y1',axisY);tick.setAttribute('y2',axisY+6);tick.setAttribute('class','axis');svg.appendChild(tick);
    const lbl=document.createElementNS('http://www.w3.org/2000/svg','text');
    lbl.setAttribute('x',x);lbl.setAttribute('y',axisY+18);lbl.setAttribute('text-anchor','middle');lbl.setAttribute('class','axis');
    lbl.textContent=t<0?`前${-t}`:`${t}`;svg.appendChild(lbl);
  }
  S('#result').style.display='';
}
S('#btnAdd').onclick=addDyn;S('#btnClear').onclick=()=>{pickedDynasties=[];renderChips();draw();};
S('#btnApplyRange').onclick=applyRange;S('#btnClearRange').onclick=clearRange;loadData();
S('#timeline-wrap').addEventListener('mouseleave', hideTip);
</script>
</body>
</html>
