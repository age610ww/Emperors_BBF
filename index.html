
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>中国皇帝时间轴（含年号）</title>
<style>
:root { --bg:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --chip-bg:#f3f4f6; --chip-border:#e5e7eb; --axis:#9ca3af; --group:#1f2937; --grid-v:#e5e7eb; --grid-h:#f3f4f6; --era:#f59e0b; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans;}
header{padding:24px 16px 0; max-width:1200px; margin:0 auto;}
h1{margin:0 0 8px; font-size:28px;}
.card{max-width:1200px;margin:16px auto;background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;}
select,input[type=number]{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text);}
.btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#111827;color:#fff;font-weight:600;cursor:pointer;}
.btn.secondary{background:transparent;color:var(--text);}
.status{margin-top:6px;color:var(--muted);font-size:13px;}
.chips{display:flex;flex-wrap:wrap;gap:8px;}
.chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip-bg);border:1px solid var(--chip-border);}
.chip .dot{width:10px;height:10px;border-radius:999px;display:inline-block;}
.chip .rm{cursor:pointer;border:none;background:transparent;color:#2563eb;font-weight:700;}
#timeline-wrap{width:100%;overflow-x:auto;}
svg{width:100%;height:auto;display:block;background:#fff;}
.axis text{fill:var(--axis);font-size:12px;}
.axis line{stroke:var(--axis);}
.label { fill: var(--group); font-size:12px; }
.bar-outline{ stroke:rgba(0,0,0,.15); stroke-width:.4; fill:none; }
.group-title{ fill:var(--group); font-size:13px; font-weight:700; }
.grid-v{ stroke: var(--grid-v); stroke-width:1; opacity:.7; }
.grid-h{ stroke: var(--grid-h); stroke-width:1; opacity:.9; }
.era{ fill: var(--era); opacity:.95; }
.legend{display:flex;gap:16px;color:var(--muted);font-size:13px;margin-bottom:6px}
.swatch{display:inline-block;width:14px;height:8px;border-radius:2px;margin-right:6px;background:var(--era)}
</style>
</head>
<body>
<header><h1>中国皇帝时间轴</h1></header>

<section class="card">
  <div class="row" style="align-items:flex-start; gap:16px;">
    <div style="display:flex; flex-direction:column; gap:8px;">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <select id="dynSelect" style="min-width:260px;"><option value="">加载中…</option></select>
        <button class="btn" id="btnAdd">添加朝代</button>
        <button class="btn secondary" id="btnClear">清空</button>
      </div>
      <div class="chips" id="chips"></div>
      <div class="status" id="status">正在加载数据…</div>
    </div>
    <div style="display:flex; flex-direction:column; gap:8px;">
      <div class="status">筛选时间段</div>
      <div class="row" style="gap:8px;">
        <input id="startYear" type="number" placeholder="起始年" style="width:160px;">
        <span class="status">到</span>
        <input id="endYear" type="number" placeholder="截止年" style="width:160px;">
        <button class="btn" id="btnApplyRange">应用</button>
        <button class="btn secondary" id="btnClearRange">清除</button>
      </div>
      <label style="user-select:none; display:flex; align-items:center; gap:8px; margin-top:4px;">
        <input id="autoPick" type="checkbox" checked> 自动选朝代
      </label>
      <label style="user-select:none; display:flex; align-items:center; gap:8px; margin-top:4px;">
        <input id="showGrid" type="checkbox" checked> 显示网格
      </label>
      <label style="user-select:none; display:flex; align-items:center; gap:8px; margin-top:4px;">
        <input id="showEra" type="checkbox"> 显示年号
      </label>
      <div class="legend"><span><span class="swatch"></span>年号区间</span></div>
    </div>
  </div>
</section>

<section class="card" id="result" style="display:none">
  <div id="timeline-wrap"><svg id="timeline"></svg></div>
</section>

<div id="tooltip" class="tooltip" style="display:none; position:fixed; background:#111827;color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
(function(){
var XLSX_URL='emperors.xlsx';
function $(q,root){return (root||document).querySelector(q)}
function parseYearPiece(str){var s=String(str||'').trim();if(s==='')return[null,null];var m=s.match(/^(-?\\d+)(?:\\.(\\d{1,2}))?$/);if(!m)return[Number(s.replace(/[^-0-9.]/g,'')),null];return[parseInt(m[1],10),m[2]?parseInt(m[2],10):null]}
function startAsFloat(y,m){if(y==null)return null;if(m==null)return y;var sign=y<0?-1:1;return y+sign*((m-1)/12)}
function endAsFloat(y,m){if(y==null)return null;if(m==null)return y;var sign=y<0?-1:1;return y+sign*(m/12)}
function ymLabel(y,m){if(y==null)return'';var t=m?Math.abs(y)+'年'+m+'月':Math.abs(y)+'年';return y<0?'公元前'+t:'公元'+t}
function hashColor(str){var h=0;for(var i=0;i<str.length;i++)h=(h*31+str.charCodeAt(i))>>>0;var hue=h%360;var sat=60+(h%20);return'hsl('+hue+' '+sat+'% 48%)'}
function niceStep(range){var raw=range/8;var p=Math.pow(10,Math.floor(Math.log10(raw)));var cs=[1,2,5,10].map(function(k){return k*p});var b=cs[0];for(var i=0;i<cs.length;i++)if(Math.abs(raw-cs[i])<Math.abs(raw-b))b=cs[i];return Math.max(1,Math.round(b))}
function clamp(n,lo,hi){return Math.max(lo,Math.min(hi,n))}

var rows=[], dynSet={}, pickedDynasties=[], customStart=null, customEnd=null;
var dynRangeMap={}, eras=[];

function loadData(){
  if(!window.XLSX){ $('#status').textContent='加载失败：XLSX 未加载'; return; }
  fetch(XLSX_URL,{cache:'no-store'}).then(function(resp){
    if(!resp.ok){ throw new Error('无法加载 emperors.xlsx') }
    return resp.arrayBuffer();
  }).then(function(buf){
    var wb=XLSX.read(buf,{type:'array'});
    rows=[]; var rowIndex=0;
    wb.SheetNames.forEach(function(sn){
      var ws=wb.Sheets[sn]; if(!ws) return;
      if(sn==='年号' || /^nianhao$/i.test(sn)) return;
      var json=XLSX.utils.sheet_to_json(ws,{raw:true,defval:''});
      json.forEach(function(r){
        var p1=parseYearPiece(r['在位起']||r['start']||r['起']||''); var sy=p1[0], sm=p1[1];
        var p2=parseYearPiece(r['在位止']||r['end']||r['止']||''); var ey=p2[0], em=p2[1];
        var startF=startAsFloat(sy,sm), endF=endAsFloat(ey,em);
        var rec={朝代:r['朝代']||'',姓名:r['姓名']||'',常用称呼:r['常用称呼']||'',在位起:startF,在位止:endF,sY:sy,sM:sm,eY:ey,eM:em,sheet:sn,idx:rowIndex++};
        if(rec.朝代 && rec.姓名 && startF!=null && endF!=null) rows.push(rec);
      });
    });
    var nSheet=wb.Sheets['年号']||wb.Sheets['nianhao'];
    eras=[];
    if(nSheet){
      XLSX.utils.sheet_to_json(nSheet,{raw:true,defval:''}).forEach(function(r){
        var s=Number(r['公元起']), e=Number(r['公元止']);
        var dyn=String(r['朝代']||'').trim(); var nm=String(r['年号']||'').trim();
        if(dyn && nm && isFinite(s) && isFinite(e) && e>=s) eras.push({dynasty:dyn,name:nm,s:s,e:e});
      });
    }
    dynRangeMap={}; dynSet={};
    rows.forEach(function(r){
      dynSet[r.朝代]=true;
      if(!dynRangeMap[r.朝代]) dynRangeMap[r.朝代]={start:r.在位起,end:r.在位止};
      dynRangeMap[r.朝代].start=Math.min(dynRangeMap[r.朝代].start,r.在位起);
      dynRangeMap[r.朝代].end=Math.max(dynRangeMap[r.朝代].end,r.在位止);
    });
    var dynList=Object.keys(dynSet).sort(function(a,b){return (dynRangeMap[a]?dynRangeMap[a].start:Infinity)-(dynRangeMap[b]?dynRangeMap[b].start:Infinity)});
    var sel=$('#dynSelect'); sel.innerHTML='<option value=\"\">选择一个朝代</option>';
    dynList.forEach(function(d){ var o=document.createElement('option'); o.value=d; o.textContent=d; sel.appendChild(o) });
    $('#status').textContent='加载完成'+(eras.length?' · 年号可用':'');
  }).catch(function(e){
    $('#status').textContent='加载失败：'+e.message;
  });
}

function renderChips(){
  var wrap=$('#chips'); wrap.innerHTML='';
  pickedDynasties.forEach(function(d){
    var chip=document.createElement('span'); chip.className='chip';
    var range=dynRangeMap[d];
    var txt=range?('（'+(range.start<0?('前'+Math.abs(Math.trunc(range.start))):Math.trunc(range.start))+' — '+(range.end<0?('前'+Math.abs(Math.trunc(range.end))):Math.trunc(range.end))+'）'):'';
    chip.innerHTML="<span class='dot' style='background:"+hashColor(d)+"'></span>"+d+txt+"<button class='rm' title='移除'>×</button>";
    chip.querySelector('.rm').addEventListener('click',function(){ removeDyn(d) });
    wrap.appendChild(chip);
  });
}

function addDyn(){ var v=$('#dynSelect').value; if(!v || pickedDynasties.indexOf(v)>=0) return;
  pickedDynasties.push(v); pickedDynasties.sort(function(a,b){return dynRangeMap[a].start-dynRangeMap[b].start}); renderChips(); draw(); }
function removeDyn(v){ pickedDynasties=pickedDynasties.filter(function(x){return x!==v}); renderChips(); draw(); }

function parseInput(val){ var p=parseYearPiece(val); if(p[0]==null) return null; return p[1]==null?p[0]:endAsFloat(p[0],p[1]) }
function autoPickByRange(){ if(!$('#autoPick').checked) return; var s=customStart!=null?customStart:-Infinity; var e=customEnd!=null?customEnd:Infinity; var matches=[]; Object.keys(dynRangeMap).forEach(function(dyn){ var rng=dynRangeMap[dyn]; if(rng.end>=s && rng.start<=e) matches.push(dyn) }); matches.sort(function(a,b){ return dynRangeMap[a].start - dynRangeMap[b].start }); pickedDynasties=matches; renderChips() }
function applyRange(){ customStart=$('#startYear').value?parseInput($('#startYear').value):null; customEnd=$('#endYear').value?parseInput($('#endYear').value):null; if(customStart!=null && customEnd!=null && customStart>customEnd){ var t=customStart; customStart=customEnd; customEnd=t } autoPickByRange(); draw(); var res=$('#result'); if(res&&res.style.display!=='none') res.scrollIntoView({behavior:'smooth',block:'start'}) }
function clearRange(){ customStart=customEnd=null; $('#startYear').value=''; $('#endYear').value=''; if($('#autoPick').checked){ pickedDynasties=[]; renderChips() } draw() }

var tip=$('#tooltip');
function showTip(html,x,y){ tip.innerHTML=html; tip.style.left=x+'px'; tip.style.top=y+'px'; tip.style.display='block' }
function hideTip(){ tip.style.display='none' }

function draw(){
  var list=rows.filter(function(r){ return pickedDynasties.indexOf(r.朝代)>=0 });
  if(!list.length){ $('#result').style.display='none'; return }
  var groups={}; list.forEach(function(r){
    if(customStart!=null && r.在位止<customStart) return;
    if(customEnd!=null && r.在位起>customEnd) return;
    if(!groups[r.朝代]) groups[r.朝代]=[]; groups[r.朝代].push(r);
  });
  var dyns=pickedDynasties.filter(function(d){ return !!groups[d] });
  if(!dyns.length){ $('#result').style.display='none'; return }
  dyns.forEach(function(d){ groups[d].sort(function(a,b){ return (a.在位起-b.在位起)||(a.在位止-b.在位止)||(a.idx-b.idx) }) });
  var all=[]; dyns.forEach(function(d){ all=all.concat(groups[d]) });
  var minYear=Math.min.apply(null, all.map(function(r){return r.在位起}));
  var maxYear=Math.max.apply(null, all.map(function(r){return r.在位止}));
  if(customStart!=null) minYear=Math.max(minYear,customStart);
  if(customEnd!=null) maxYear=Math.min(maxYear,customEnd);
  var range=Math.max(1,maxYear-minYear);

  var wrap=$('#timeline-wrap');
  var W=Math.max(1100,wrap.clientWidth-2);
  var leftPad=200,rightPad=24,topPad=24,rowH=28,gap=8,groupGap=18;
  var rowsCount=0; dyns.forEach(function(d){ rowsCount+=groups[d].length });
  var H=topPad+dyns.length*24+rowsCount*(rowH+gap)+(dyns.length-1)*groupGap+80;
  var axisY=H-40;
  var scale=function(y){ return leftPad+((y-minYear)/range)*(W-leftPad-rightPad) };
  var svg=$('#timeline'); svg.setAttribute('width',W); svg.setAttribute('height',H); svg.innerHTML='';

  var gridLayer=document.createElementNS('http://www.w3.org/2000/svg','g'); gridLayer.setAttribute('id','gridLayer'); svg.appendChild(gridLayer);
  var barsLayer=document.createElementNS('http://www.w3.org/2000/svg','g'); barsLayer.setAttribute('id','barsLayer'); svg.appendChild(barsLayer);

  var step=niceStep(range);
  var startTick=Math.ceil(minYear/step)*step;
  if($('#showGrid').checked){
    for(var t=startTick;t<=maxYear;t+=step){
      var x=scale(t);
      var vline=document.createElementNS('http://www.w3.org/2000/svg','line');
      vline.setAttribute('x1',x); vline.setAttribute('x2',x); vline.setAttribute('y1',topPad); vline.setAttribute('y2',axisY); vline.setAttribute('class','grid-v'); gridLayer.appendChild(vline);
    }
  }

  var cursorY=topPad;
  dyns.forEach(function(d){
    var headerH=22;
    var title=document.createElementNS('http://www.w3.org/2000/svg','text');
    title.setAttribute('x',12); title.setAttribute('y',cursorY+10); title.setAttribute('class','group-title');
    var rr=dynRangeMap[d];
    var rangeTxt=rr?('（'+(rr.start<0?('前'+Math.abs(Math.trunc(rr.start))):Math.trunc(rr.start))+' — '+(rr.end<0?('前'+Math.abs(Math.trunc(rr.end))):Math.trunc(rr.end))+'）'):'';
    title.textContent=d+(rangeTxt?(' '+rangeTxt):'');
    barsLayer.appendChild(title);
    cursorY+=headerH;

    groups[d].forEach(function(r,i){
      var y=cursorY+i*(rowH+gap);
      if($('#showGrid').checked){
        var hline=document.createElementNS('http://www.w3.org/2000/svg','line');
        hline.setAttribute('x1',leftPad); hline.setAttribute('x2',W-rightPad); hline.setAttribute('y1',y+rowH); hline.setAttribute('y2',y+rowH); hline.setAttribute('class','grid-h'); gridLayer.appendChild(hline);
      }
      var s=customStart!=null?clamp(r.在位起,customStart,Infinity):r.在位起;
      var e=customEnd!=null?clamp(r.在位止,-Infinity,customEnd):r.在位止;
      var x1=scale(s), x2=scale(e);
      var alias=r.常用称呼||r.姓名;

      var name=document.createElementNS('http://www.w3.org/2000/svg','text');
      name.setAttribute('x',leftPad-10); name.setAttribute('y',y+rowH*0.7);
      name.setAttribute('text-anchor','end'); name.setAttribute('class','label');
      name.textContent=(alias===r.姓名?alias:(alias+' '+r.姓名));
      barsLayer.appendChild(name);

      var rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x',Math.min(x1,x2)); rect.setAttribute('y',y); rect.setAttribute('width',Math.max(4,Math.abs(x2-x1))); rect.setAttribute('height',rowH); rect.setAttribute('rx',6);
      rect.setAttribute('fill',hashColor(d));
      rect.addEventListener('mousemove',function(ev){ showTip((alias===r.姓名?alias:(alias+' '+r.姓名))+'<br>'+ymLabel(r.sY,r.sM)+' — '+ymLabel(r.eY,r.eM),ev.clientX,ev.clientY) });
      rect.addEventListener('mouseleave',hideTip);
      barsLayer.appendChild(rect);

      var outline=document.createElementNS('http://www.w3.org/2000/svg','rect');
      outline.setAttribute('x',Math.min(x1,x2)); outline.setAttribute('y',y); outline.setAttribute('width',Math.max(4,Math.abs(x2-x1))); outline.setAttribute('height',rowH); outline.setAttribute('rx',6); outline.setAttribute('class','bar-outline');
      barsLayer.appendChild(outline);

      if($('#showEra').checked && eras.length){
        var rel = eras.filter(function(er){ return er.dynasty===d && er.e>=r.在位起 && er.s<=r.在位止 }).sort(function(a,b){return a.s-b.s});
        rel.forEach(function(er){
          var sx = scale(Math.max(er.s, r.在位起, customStart!=null?customStart:-Infinity));
          var ex = scale(Math.min(er.e, r.在位止, customEnd!=null?customEnd:Infinity));
          var w = Math.max(2, ex - sx);
          var ey = y + 4;
          var eh = rowH - 8;
          var eRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
          eRect.setAttribute('x', sx); eRect.setAttribute('y', ey); eRect.setAttribute('width', w); eRect.setAttribute('height', eh); eRect.setAttribute('rx',3); eRect.setAttribute('class','era');
          eRect.addEventListener('mousemove', function(ev){ showTip('<strong>'+er.name+'</strong>（'+d+'）<br/>'+er.s+' — '+er.e, ev.clientX, ev.clientY) });
          eRect.addEventListener('mouseleave', hideTip);
          barsLayer.appendChild(eRect);
          if (w > 44) {
            var t = document.createElementNS('http://www.w3.org/2000/svg','text');
            t.setAttribute('x', sx+4); t.setAttribute('y', ey+eh*0.68); t.setAttribute('class','label');
            t.textContent = er.name; barsLayer.appendChild(t);
          }
        });
      }
    });

    cursorY += groups[d].length*(rowH+gap)+groupGap;
  });

  var axisLine=document.createElementNS('http://www.w3.org/2000/svg','line');
  var H=$('#timeline').getAttribute('height'); var axisY2=H-40;
  axisLine.setAttribute('x1',200); axisLine.setAttribute('x2',W-24); axisLine.setAttribute('y1',axisY2); axisLine.setAttribute('y2',axisY2); axisLine.setAttribute('class','axis');
  barsLayer.appendChild(axisLine);
  var step2=niceStep(range); var startTick2=Math.ceil(minYear/step2)*step2;
  for(var t=startTick2;t<=maxYear;t+=step2){
    var x=leftPad+((t-minYear)/range)*(W-leftPad-rightPad);
    var tick=document.createElementNS('http://www.w3.org/2000/svg','line');
    tick.setAttribute('x1',x); tick.setAttribute('x2',x); tick.setAttribute('y1',axisY2); tick.setAttribute('y2',axisY2+6); tick.setAttribute('class','axis'); barsLayer.appendChild(tick);
    var lbl=document.createElementNS('http://www.w3.org/2000/svg','text');
    lbl.setAttribute('x',x); lbl.setAttribute('y',axisY2+18); lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('class','axis');
    lbl.textContent=t<0?('前'+(-t)):(''+t); barsLayer.appendChild(lbl);
  }
  $('#result').style.display='';
}

document.getElementById('btnAdd').addEventListener('click',addDyn);
document.getElementById('btnClear').addEventListener('click',function(){pickedDynasties=[];renderChips();draw()});
document.getElementById('btnApplyRange').addEventListener('click',applyRange);
document.getElementById('btnClearRange').addEventListener('click',clearRange);
document.getElementById('showGrid').addEventListener('change',function(){draw()});
document.getElementById('showEra').addEventListener('change',function(){draw()});

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadData);
} else {
  loadData();
}

// 若 5 秒仍为“正在加载数据…”，在状态栏标明失败原因（无弹窗、无提示条）
setTimeout(function(){
  var st=$('#status').textContent||'';
  if(/正在加载数据/.test(st)){
    $('#status').textContent='加载失败：未能读取 XLSX 或 emperors.xlsx 不在同一目录';
  }
}, 5000);

document.getElementById('timeline-wrap').addEventListener('mouseleave',function(){document.getElementById('tooltip').style.display='none'});
})();
</script>
</body>
</html>
