<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>中国皇帝时间轴（修复版）</title>
  <style>
    :root { --bg:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --danger:#ef4444; --chip:#0b1220; --chip-border:rgba(148,163,184,.35); }
    *{box-sizing:border-box;} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans;}
    header{padding:24px 16px 8px; max-width:1200px; margin:0 auto;} h1{margin:0 0 8px; font-size:28px;} .sub{color:var(--muted); font-size:14px;}
    .card{max-width:1200px;margin:16px auto;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid rgba(148,163,184,.2);border-radius:16px;padding:16px;}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;}
    select,input[type=number]{padding:10px 12px;border-radius:12px;border:1px solid rgba(148,163,184,.25);background:#0b1220;color:var(--text);}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid rgba(148,163,184,.25);background:#60a5fa;color:#07131f;font-weight:600;cursor:pointer;}
    .btn.secondary{background:transparent;color:var(--text);} .status{margin-top:6px;color:var(--muted);font-size:13px;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;} .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-border);}
    .chip .dot{width:10px;height:10px;border-radius:999px;display:inline-block;} .chip .rm{cursor:pointer;border:none;background:transparent;color:#93c5fd;font-weight:700;}
    #timeline-wrap{width:100%;overflow-x:auto;} svg{width:100%;height:auto;display:block;}
    .axis text{fill:#94a3b8;font-size:12px;} .axis line{stroke:rgba(148,163,184,.35);} .label{fill:#e5e7eb;font-size:12px;}
    .bar-outline{stroke:rgba(255,255,255,.55);stroke-width:.4;fill:none;} .group-title{fill:#cbd5e1;font-size:13px;font-weight:700;} .band{fill:rgba(148,163,184,.06);}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header>
  <h1>中国皇帝时间轴（修复版）</h1>
  <div class="sub">修复了“正则表达式错误”。支持多朝代添加、自定义时间段、显示“常用称呼 姓名”。</div>
</header>

<section class="card">
  <div class="row" style="align-items:flex-start; gap:16px;">
    <div style="display:flex; flex-direction:column; gap:8px;">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <select id="dynSelect" style="min-width:260px;"><option value="">加载中…</option></select>
        <button class="btn" id="btnAdd">添加朝代</button>
        <button class="btn secondary" id="btnClear">清空</button>
      </div>
      <div class="chips" id="chips"></div>
      <div class="status" id="status">正在加载数据…</div>
    </div>
    <div style="display:flex; flex-direction:column; gap:8px;">
      <div>筛选时间段（支持负数，例：-221 到 220）</div>
      <div class="row" style="gap:8px;">
        <input id="startYear" type="number" placeholder="起始年" style="width:120px;">
        <span>到</span>
        <input id="endYear" type="number" placeholder="截止年" style="width:120px;">
        <button class="btn" id="btnApplyRange">应用</button>
        <button class="btn secondary" id="btnClearRange">清除</button>
      </div>
    </div>
  </div>
</section>

<section class="card" id="result" style="display:none">
  <div id="timeline-wrap"><svg id="timeline"></svg></div>
</section>

<script>
const XLSX_URL = 'emperors.xlsx';
const S=(q,e=document)=>e.querySelector(q);
function parseNum(v){if(v==null||v==='')return null;const s=String(v).trim();if(/^公元?前/.test(s)||/^前/.test(s))return-Number(s.replace(/[^-0-9.]/g,''));if(/BCE/i.test(s))return-Number(s.replace(/[^-0-9.]/g,''));const n=Number(s.replace(/[^-0-9.]/g,''));return isNaN(n)?null:n;}
function yearLabel(y){if(y==null)return'';return y<0?`公元前${-y}年`:`公元${y}年`;}
function hashColor(str){let h=0;for(let i=0;i<str.length;i++)h=(h*31+str.charCodeAt(i))>>>0;const hue=h%360;const sat=60+(h%20);return`hsl(${hue} ${sat}% 50%)`;}

let rows=[],dynSet=new Set(),pickedDynasties=[],customStart=null,customEnd=null;
async function loadData(){
  try{
    const resp=await fetch(XLSX_URL);if(!resp.ok)throw new Error('无法加载 emperors.xlsx');const buf=await resp.arrayBuffer();const wb=XLSX.read(buf,{type:'array'});
    rows=[];wb.SheetNames.forEach(sn=>{const ws=wb.Sheets[sn];if(!ws)return;const json=XLSX.utils.sheet_to_json(ws,{raw:true,defval:''});json.forEach(r=>{const rec={朝代:r['朝代']??'',姓名:r['姓名']??'',常用称呼:r['常用称呼']??'',在位起:parseNum(r['在位起']),在位止:parseNum(r['在位止']),sheet:sn};if(rec.朝代&&rec.姓名)rows.push(rec);});});
    rows.forEach(r=>dynSet.add(r.朝代));const sel=S('#dynSelect');sel.innerHTML='<option value="">选择一个朝代</option>';[...dynSet].sort().forEach(d=>{const o=document.createElement('option');o.value=d;o.textContent=d;sel.appendChild(o);});S('#status').textContent='加载完成';}
  catch(e){S('#status').textContent='加载失败：'+e.message;}
}
function addDyn(){const v=S('#dynSelect').value;if(!v||pickedDynasties.includes(v))return;pickedDynasties.push(v);render();draw();}
function render(){const c=S('#chips');c.innerHTML='';pickedDynasties.forEach(d=>{const chip=document.createElement('span');chip.className='chip';chip.innerHTML=`<span class='dot' style='background:${hashColor(d)}'></span>${d}<button class='rm'>×</button>`;chip.querySelector('.rm').onclick=()=>{pickedDynasties=pickedDynasties.filter(x=>x!==d);render();draw();};c.appendChild(chip);});}
function applyRange(){customStart=S('#startYear').value?Number(S('#startYear').value):null;customEnd=S('#endYear').value?Number(S('#endYear').value):null;if(customStart&&customEnd&&customStart>customEnd)[customStart,customEnd]=[customEnd,customStart];draw();}
function clearRange(){customStart=customEnd=null;S('#startYear').value='';S('#endYear').value='';draw();}
function draw(){const list=rows.filter(r=>pickedDynasties.includes(r.朝代));if(!list.length){S('#result').style.display='none';return;}const groups={};list.forEach(r=>{if(r.在位起==null||r.在位止==null)return;if(customStart&&r.在位止<customStart)return;if(customEnd&&r.在位起>customEnd)return;(groups[r.朝代]??=[]).push(r);});const dyns=pickedDynasties.filter(d=>groups[d]);if(!dyns.length){S('#result').style.display='none';return;}dyns.forEach(d=>groups[d].sort((a,b)=>a.在位起-b.在位起));const all=dyns.flatMap(d=>groups[d]);let min=Math.min(...all.map(r=>r.在位起)),max=Math.max(...all.map(r=>r.在位止));if(customStart)min=Math.max(min,customStart);if(customEnd)max=Math.min(max,customEnd);const range=max-min;const svg=S('#timeline');svg.innerHTML='';const left=200,rowH=24,gap=6,top=20;let y=top;dyns.forEach(d=>{const color=hashColor(d);const t=document.createElementNS('http://www.w3.org/2000/svg','text');t.setAttribute('x',10);t.setAttribute('y',y+10);t.setAttribute('fill','#cbd5e1');t.textContent=d;svg.appendChild(t);y+=20;groups[d].forEach(r=>{const s=Math.max(r.在位起,customStart??-1e9),e=Math.min(r.在位止,customEnd??1e9);const x1=left+(s-min)/range*800,x2=left+(e-min)/range*800;const g=document.createElementNS('http://www.w3.org/2000/svg','g');const name=document.createElementNS('http://www.w3.org/2000/svg','text');name.setAttribute('x',left-10);name.setAttribute('y',y+rowH*0.7);name.setAttribute('text-anchor','end');name.setAttribute('class','label');name.textContent=(r.常用称呼?r.常用称呼+' ':'')+r.姓名;g.appendChild(name);const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');rect.setAttribute('x',x1);rect.setAttribute('y',y);rect.setAttribute('width',Math.max(4,x2-x1));rect.setAttribute('height',rowH);rect.setAttribute('rx',5);rect.setAttribute('fill',color);g.appendChild(rect);svg.appendChild(g);y+=rowH+gap;});y+=10;});svg.setAttribute('height',y+50);S('#result').style.display='';}
S('#btnAdd').onclick=addDyn;S('#btnClear').onclick=()=>{pickedDynasties=[];render();draw();};S('#btnApplyRange').onclick=applyRange;S('#btnClearRange').onclick=clearRange;loadData();
</script>
</body>
</html>
