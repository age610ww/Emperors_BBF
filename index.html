<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>中国皇帝时间轴 · 调试版（定位“加载中”问题）</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#fff;color:#111}
header{padding:16px 12px}
pre{white-space:pre-wrap;background:#0b1021;color:#d1d5db;padding:12px;margin:12px;border-radius:10px;overflow:auto;max-height:40vh}
.card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin:12px}
.status{font-size:14px;color:#374151}
.status.err{color:#b91c1c}
#log small{color:#93c5fd}
</style>
</head>
<body>
<header><h2>中国皇帝时间轴 · 调试版</h2></header>

<div class="card">
  <div>状态：<span id="status" class="status">正在加载数据…</span></div>
  <details open class="card"><summary>诊断日志</summary><pre id="log"></pre></details>
</div>

<div class="card">
  <div>下拉：<select id="dynSelect"><option value="">加载中…</option></select></div>
  <div id="result" style="margin-top:8px"></div>
</div>

<script>
(function(){
const XLSX_URL = 'emperors.xlsx';
const logEl = document.getElementById('log');
function log(...args){
  const t = new Date().toISOString().slice(11,19);
  logEl.textContent += '['+t+'] ' + args.join(' ') + '\\n';
  console.log(...args);
}
function $(q,root){return (root||document).querySelector(q)}

function parseYearPiece(str){
  var s=String(str||'').trim();
  if(s==='')return[null,null];
  var m=s.match(/^(-?\\d+)(?:\\.(\\d{1,2}))?$/); // 先用字符串里的转义，稍后会换成真正的正则
  return m? [parseInt(m[1],10), m[2]?parseInt(m[2],10):null]
          : [Number(s.replace(/[^-0-9.]/g,'')), null];
}
// 用真正的正则字面量覆盖
parseYearPiece = (function(){
  return function(str){
    var s=String(str||'').trim();
    if(s==='')return[null,null];
    var m=s.match(/^(-?\d+)(?:\.(\d{1,2}))?$/);
    return m? [parseInt(m[1],10), m[2]?parseInt(m[2],10):null]
            : [Number(s.replace(/[^-0-9.]/g,'')), null];
  }
})();

function startAsFloat(y,m){if(y==null)return null;if(m==null)return y;var sign=y<0?-1:1;return y+sign*((m-1)/12)}
function endAsFloat(y,m){if(y==null)return null;if(m==null)return y;var sign=y<0?-1:1;return y+sign*(m/12)}

function loadData(){
  const statusEl = $('#status');
  function fail(msg){
    statusEl.classList.add('err'); statusEl.textContent = msg;
    log('ERROR:', msg);
    const sel=$('#dynSelect'); if(sel && sel.options.length){ sel.options[0].text='无法加载数据'; }
  }

  log('页面路径', location.href);
  log('将从', XLSX_URL, '加载数据（相对路径）');

  if(typeof XLSX==='undefined'){
    fail('未能加载 XLSX 库（cdn）');
    log('window.XLSX =', typeof XLSX);
    return;
  }

  fetch(XLSX_URL, {cache:'no-store'}).then(function(r){
    log('fetch emperors.xlsx 响应：', r.status, r.statusText);
    if(!r.ok) throw new Error('无法加载 emperors.xlsx（HTTP '+r.status+'）');
    return r.arrayBuffer();
  }).then(function(buf){
    log('arrayBuffer 大小', buf.byteLength, '字节');
    var wb = XLSX.read(buf,{type:'array'});
    log('工作表名：', JSON.stringify(wb.SheetNames));

    var rows=[], dynSet={}, dynRangeMap={};
    var rowIndex=0;
    wb.SheetNames.forEach(function(sn){
      if(sn==='年号'||/^nianhao$/i.test(sn))return;
      var ws=wb.Sheets[sn]; if(!ws)return;
      var json=XLSX.utils.sheet_to_json(ws,{raw:true,defval:''});
      log('解析工作表', sn, '记录数', json.length);
      json.forEach(function(r){
        var p1=parseYearPiece(r['在位起']||'');var sy=p1[0],sm=p1[1];
        var p2=parseYearPiece(r['在位止']||'');var ey=p2[0],em=p2[1];
        var s=startAsFloat(sy,sm), e=endAsFloat(ey,em);
        var rec={朝代:r['朝代']||'',姓名:r['姓名']||'',常用称呼:r['常用称呼']||'',在位起:s,在位止:e,idx:rowIndex++};
        if(rec.朝代 && rec.姓名 && s!=null && e!=null){
          rows.push(rec); dynSet[rec.朝代]=true;
          if(!dynRangeMap[rec.朝代]) dynRangeMap[rec.朝代]={start:s,end:e};
          dynRangeMap[rec.朝代].start=Math.min(dynRangeMap[rec.朝代].start,s);
          dynRangeMap[rec.朝代].end=Math.max(dynRangeMap[rec.朝代].end,e);
        }
      });
    });

    var sel=$('#dynSelect'); sel.innerHTML='<option value=\"\">选择一个朝代</option>';
    Object.keys(dynSet).sort(function(a,b){return dynRangeMap[a].start-dynRangeMap[b].start})
      .forEach(function(d){var o=document.createElement('option');o.value=d;o.textContent=d;sel.appendChild(o)});

    statusEl.classList.remove('err');
    statusEl.textContent='加载完成 · 皇帝'+rows.length;

    $('#result').innerHTML = '<div>检测到 <b>'+rows.length+'</b> 条皇帝记录，朝代 <b>'+Object.keys(dynSet).length+'</b> 个。</div>';
  }).catch(function(e){
    fail('加载失败：'+(e && e.message ? e.message : e));
  });
}

if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',loadData)}else{loadData()}
})();
</script>

<!-- 放在最后，确保能看到是否加载成功 -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</body>
</html>
