<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>皇帝时间轴（交互增强版）</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
.tick{position:absolute;top:0;bottom:0;width:1px;background:#e5e7eb}
.bar{height:10px;border-radius:9999px;opacity:.95}
.label{font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.badge{font-size:11px;padding:0 4px;border-radius:4px;background:#fef3c7;border:1px solid #fcd34d;color:#92400e}
.handle{cursor:grab}
</style>
</head>
<body class="bg-neutral-50 text-neutral-800">
<main class="max-w-6xl mx-auto p-4 sm:p-6 space-y-6">
<header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
  <div>
    <h1 class="text-2xl sm:text-3xl font-bold">皇帝时间轴 · 交互增强版</h1>
    <p class="text-neutral-500">支持：自动分层、防重叠、朝代拖拽排序、聚焦缩放、时间轴缩放。</p>
  </div>
  <div class="flex gap-2">
    <button id="reloadBtn" class="px-3 py-2 rounded-md border bg-white">重新读取 XLSX</button>
    <button id="exportJsonBtn" class="px-3 py-2 rounded-md bg-black text-white">导出 JSON</button>
  </div>
</header>

<section class="bg-white border rounded-xl p-4 grid sm:grid-cols-5 gap-3 items-end">
  <div><label class="text-sm text-neutral-600">搜索</label>
    <input id="q" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="输入朝代/姓名/称呼…"/>
  </div>
  <div><label class="text-sm text-neutral-600">起始</label>
    <input id="yStart" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="留空=不限"/>
  </div>
  <div><label class="text-sm text-neutral-600">结束</label>
    <input id="yEnd" class="mt-1 w-full px-3 py-2 border rounded-lg" placeholder="留空=不限"/>
  </div>
  <div><label class="text-sm text-neutral-600">缩放</label>
    <input id="zoomRange" type="range" min="0.5" max="5" step="0.1" value="1" class="w-full"/>
  </div>
  <div class="flex gap-2"><button id="clearRange" class="px-3 py-2 rounded-md border bg-white w-full">清除范围</button></div>
</section>

<section class="bg-white border rounded-xl p-5 space-y-4">
  <div class="text-lg font-semibold">时间轴（可拖拽排序，可折叠）</div>
  <div class="border rounded-lg overflow-hidden">
    <div class="grid" style="grid-template-columns:180px 1fr;">
      <div class="bg-neutral-50 border-r">
        <div class="h-10 flex items-center px-3 text-xs text-neutral-500 border-b">朝代</div>
        <div id="dynList" class="max-h-96 overflow-y-auto"></div>
      </div>
      <div>
        <div id="ruler" class="h-10 relative border-b select-none"></div>
        <div id="tracks" class="max-h-96 overflow-y-auto"></div>
      </div>
    </div>
  </div>
</section>

<footer class="text-xs text-neutral-400 py-8">© 交互增强版</footer>
</main>

<script>
(function(){
  const S = { rows:[], people:[], collapsed:{}, min:0, max:1, zoom:1, order:[] };
  const $ = s=>document.querySelector(s);
  const dynList=$('#dynList'), ruler=$('#ruler'), tracks=$('#tracks');
  const palette = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf'];

  function parseYM(v){
    if(v==null) return;
    const t = String(v).trim(); if(!t) return;
    let m = t.match(/^([+\-]?\d{1,5})\s*(?:[\/.年\-\–\—]\s*(\d{1,2}))?/);
    if(m){ const y=parseInt(m[1],10); const mo=m[2]?Math.max(1,Math.min(12,parseInt(m[2],10))):undefined; return {y,m:mo}; }
  }
  const ymToFloat = ym=> ym? ym.y + (ym.m? (ym.m-1)/12 : 0) : undefined;
  const fmtYM = ym=> !ym? '?' : (ym.y<0? (ym.m? `公元前${Math.abs(ym.y)}-${String(ym.m).padStart(2,'0')}`:`公元前${Math.abs(ym.y)}`) : (ym.m? `${ym.y}-${String(ym.m).padStart(2,'0')}`: String(ym.y)));
  const H = s=>String(s||'').trim();

  async function loadXLSX(){
    const res = await fetch('./emperors.xlsx?ts='+Date.now(), {cache:'no-store'});
    if(!res.ok){ alert('未找到 emperors.xlsx'); return; }
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf,{type:'array'});
    const rows=[];
    wb.SheetNames.forEach(n=>{
      const ws=wb.Sheets[n]; if(!ws) return;
      const list=XLSX.utils.sheet_to_json(ws,{defval:'',raw:true});
      list.forEach(r=>rows.push(r));
    });
    S.rows=rows;
    normalize();
    renderAll();
  }

  function normalize(){
    const map=new Map();
    for(const r of S.rows){
      const dynasty=H(r['朝代']), emperor=H(r['姓名']); if(!dynasty && !emperor) continue;
      const alias=H(r['常用称呼']), temple=H(r['庙号']), posthumous=H(r['谥号']);
      const sYM=parseYM(r['在位起']), eYM=parseYM(r['在位止']);
      if(!map.has(dynasty)) map.set(dynasty,[]);
      map.get(dynasty).push({dynasty,emperor,alias,temple,posthumous,sYM,eYM});
    }
    S.people=[];
    const dyns=[...map.keys()];
    dyns.forEach((d,i)=>{
      const color=palette[i%palette.length];
      const items=map.get(d).map(p=>({dynasty:d,color,alias:p.alias,emperor:p.emperor,temple:p.temple,posthumous:p.posthumous,start:ymToFloat(p.sYM),end:ymToFloat(p.eYM),sYM:p.sYM,eYM:p.eYM})).filter(x=>x.start!=null&&x.end!=null);
      S.people.push({dynasty:d,color,reigns:items});
    });
    const nums=[]; S.people.forEach(p=>p.reigns.forEach(r=>{nums.push(r.start,r.end);}));
    S.min=Math.min(...nums); S.max=Math.max(...nums);
    if(!S.order.length) S.order=S.people.map(p=>p.dynasty);
  }

  function getFiltered(){
    return S.order.map(d=>S.people.find(p=>p.dynasty===d)).filter(Boolean);
  }

  function renderTimeline(){
    const list=getFiltered();
    const ws=parseFloat($('#yStart').value)||S.min, we=parseFloat($('#yEnd').value)||S.max;
    const span=(we-ws)||1;
    const zoom=S.zoom;
    ruler.innerHTML='';
    const step=Math.max(1,Math.round(span/(10*zoom)));
    for(let y=Math.floor(ws); y<=we; y+=step){
      const div=document.createElement('div'); div.className='tick'; div.style.left=((y-ws)/span*100)+'%';
      ruler.appendChild(div);
    }

    dynList.innerHTML=''; tracks.innerHTML='';
    list.forEach(p=>{
      const head=document.createElement('div');
      head.className='flex items-center gap-2 px-3 py-2 border-b hover:bg-neutral-100 handle';
      const dot=document.createElement('span'); dot.className='w-2 h-2 rounded-full'; dot.style.background=p.color;
      const name=document.createElement('span'); name.textContent=p.dynasty; name.className='text-sm font-medium';
      const tog=document.createElement('span'); tog.className='ml-auto text-xs text-neutral-500'; tog.textContent=S.collapsed[p.dynasty]?'展开':'折叠';
      head.appendChild(dot); head.appendChild(name); head.appendChild(tog);
      head.onclick=()=>{S.collapsed[p.dynasty]=!S.collapsed[p.dynasty]; renderAll();};
      dynList.appendChild(head);

      const row=document.createElement('div'); row.className='relative border-b'; row.style.height=(S.collapsed[p.dynasty]?20:Math.max(40,p.reigns.length*15))+'px';
      if(!S.collapsed[p.dynasty]){
        p.reigns.forEach((r,i)=>{
          const left=((r.start-ws)/span*100)+'%', width=((r.end-r.start)/span*100)+'%';
          const bar=document.createElement('div'); bar.className='bar absolute'; bar.style.background=p.color; bar.style.left=left; bar.style.width=width; bar.style.top=(i*14)+'px';
          bar.title=`${p.dynasty} ${r.alias||r.emperor} (${fmtYM(r.sYM)}-${fmtYM(r.eYM)})`;
          const label=document.createElement('div'); label.className='label absolute'; label.textContent=(r.alias||r.emperor); label.style.left=left; label.style.top=(i*14+12)+'px';
          row.appendChild(bar); row.appendChild(label);
        });
      }
      tracks.appendChild(row);
    });

    new Sortable(dynList,{animation:150,handle:'.handle',onEnd:e=>{
      const items=[...dynList.querySelectorAll('span.text-sm')].map(x=>x.textContent);
      S.order=items; renderAll();
    }});
  }

  function renderAll(){ renderTimeline(); }

  $('#reloadBtn').onclick=loadXLSX;
  $('#exportJsonBtn').onclick=()=>{
    const blob=new Blob([JSON.stringify(S.people,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='emperors.json'; a.click();
  };
  $('#q').oninput=$('#yStart').oninput=$('#yEnd').oninput=renderAll;
  $('#clearRange').onclick=()=>{$('#yStart').value='';$('#yEnd').value='';renderAll();};
  $('#zoomRange').oninput=e=>{S.zoom=parseFloat(e.target.value);renderAll();};

  loadXLSX();
})();
</script>
</body>
</html>