
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>中国皇帝时间轴（含年号）</title>
  <style>
    :root { --bg:#ffffff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --chip-bg:#f3f4f6; --chip-border:#e5e7eb; --axis:#9ca3af; --group:#1f2937; --accent:#2563eb; --grid-v:#e5e7eb; --grid-h:#f3f4f6; --era:#f59e0b; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans;}
    header{padding:24px 16px 0; max-width:1200px; margin:0 auto;}
    h1{margin:0 0 8px; font-size:28px;}
    .card{max-width:1200px;margin:16px auto;background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;}
    .row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;}
    select,input[type=number]{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;color:var(--text);}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#111827;color:#fff;font-weight:600;cursor:pointer;}
    .btn.secondary{background:transparent;color:var(--text);}
    .status{margin-top:6px;color:var(--muted);font-size:13px;}
    .chips{display:flex;flex-wrap:wrap;gap:8px;}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:var(--chip-bg);border:1px solid var(--chip-border);}
    .chip .dot{width:10px;height:10px;border-radius:999px;display:inline-block;}
    .chip .rm{cursor:pointer;border:none;background:transparent;color:var(--accent);font-weight:700;}
    #timeline-wrap{width:100%;overflow-x:auto;}
    svg{width:100%;height:auto;display:block;background:#fff;}
    .axis text{fill:var(--axis);font-size:12px;}
    .axis line{stroke:var(--axis);}
    .label { fill: var(--group); font-size:12px; }
    .bar-outline{ stroke:rgba(0,0,0,.15); stroke-width:.4; fill:none; }
    .group-title{ fill:var(--group); font-size:13px; font-weight:700; }
    .tooltip{ position: fixed; pointer-events:none; z-index: 10; background:#111827; color:#fff; padding:6px 8px; border-radius:8px; font-size:12px; box-shadow:0 6px 18px rgba(0,0,0,.15); transform: translate(-50%, -120%); opacity:0; transition: opacity .12s ease; white-space:nowrap; }
    .tooltip.show{ opacity:1; }
    .grid-v{ stroke: var(--grid-v); stroke-width:1; opacity:.7; }
    .grid-h{ stroke: var(--grid-h); stroke-width:1; opacity:.9; }
    .era{ fill: var(--era); opacity:.95; }
    .legend{display:flex;gap:16px;color:var(--muted);font-size:13px;margin-bottom:6px}
    .swatch{display:inline-block;width:14px;height:8px;border-radius:2px;margin-right:6px;background:var(--era)}
  </style>
</head>
<body>
<header><h1>中国皇帝时间轴</h1></header>

<section class="card">
  <div class="row" style="align-items:flex-start; gap:16px;">
    <div style="display:flex; flex-direction:column; gap:8px;">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <select id="dynSelect" style="min-width:260px;"><option value="">加载中…</option></select>
        <button class="btn" id="btnAdd">添加朝代</button>
        <button class="btn secondary" id="btnClear">清空</button>
      </div>
      <div class="chips" id="chips"></div>
      <div class="status" id="status">正在加载数据…</div>
    </div>
    <div style="display:flex; flex-direction:column; gap:8px;">
      <div class="status">筛选时间段</div>
      <div class="row" style="gap:8px;">
        <input id="startYear" type="number" placeholder="起始年" style="width:160px;">
        <span class="status">到</span>
        <input id="endYear" type="number" placeholder="截止年" style="width:160px;">
        <button class="btn" id="btnApplyRange">应用</button>
        <button class="btn secondary" id="btnClearRange">清除</button>
      </div>
      <label style="user-select:none; display:flex; align-items:center; gap:8px; margin-top:4px;">
        <input id="autoPick" type="checkbox" checked> 自动选朝代
      </label>
      <label style="user-select:none; display:flex; align-items:center; gap:8px; margin-top:4px;">
        <input id="showGrid" type="checkbox" checked> 显示网格
      </label>
      <label style="user-select:none; display:flex; align-items:center; gap:8px; margin-top:4px;">
        <input id="showEra" type="checkbox"> 显示年号
      </label>
      <div class="legend"><span><span class="swatch"></span>年号区间</span></div>
    </div>
  </div>
</section>

<section class="card" id="result" style="display:none">
  <div id="timeline-wrap"><svg id="timeline"></svg></div>
</section>

<div id="tooltip" class="tooltip"></div>

<!-- 只用一个可靠 CDN，避免脚本加载失败造成“卡在加载中” -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
const XLSX_URL='emperors.xlsx';
const S=(q,e=document)=>e.querySelector(q);
function parseYearPiece(str){const s=String(str).trim();if(s==='')return[null,null];const m=s.match(/^(-?\\d+)(?:\\.(\\d{1,2}))?$/);if(!m)return[Number(s.replace(/[^-0-9.]/g,'')),null];return[parseInt(m[1],10),m[2]?parseInt(m[2],10):null]}
function startAsFloat(y,m){if(y==null)return null;if(m==null)return y;const sign=y<0?-1:1;return y+sign*((m-1)/12)}
function endAsFloat(y,m){if(y==null)return null;if(m==null)return y;const sign=y<0?-1:1;return y+sign*(m/12)}
function ymLabel(y,m){if(y==null)return'';const t=m?`${Math.abs(y)}年${m}月`:`${Math.abs(y)}年`;return y<0?`公元前${t}`:`公元${t}`}
function hashColor(str){let h=0;for(let i=0;i<str.length;i++)h=(h*31+str.charCodeAt(i))>>>0;const hue=h%360;const sat=60+(h%20);return`hsl(${hue} ${sat}% 48%)`}
function niceStep(range){const raw=range/8;const p=Math.pow(10,Math.floor(Math.log10(raw)));const cs=[1,2,5,10].map(k=>k*p);let b=cs[0];for(const c of cs)if(Math.abs(raw-c)<Math.abs(raw-b))b=c;return Math.max(1,Math.round(b))}
function clamp(n,lo,hi){return Math.max(lo,Math.min(hi,n))}

let rows=[], dynSet=new Set(), pickedDynasties=[], customStart=null, customEnd=null;
const dynRangeMap=new Map(); let eras=[];

async function loadData(){
  try{
    if(!window.XLSX) throw new Error('XLSX 脚本未加载');
    const resp=await fetch(XLSX_URL,{cache:'no-store'});
    if(!resp.ok)throw new Error('无法加载 '+XLSX_URL+' (HTTP '+resp.status+')');
    const buf=await resp.arrayBuffer();
    const wb=XLSX.read(buf,{type:'array'});
    // 读取皇帝表
    rows=[];let rowIndex=0;
    wb.SheetNames.forEach(sn=>{
      const ws=wb.Sheets[sn]; if(!ws) return;
      if(sn==='年号' || /^nianhao$/i.test(sn)) return; // 年号表另读
      const json=XLSX.utils.sheet_to_json(ws,{raw:true,defval:''});
      json.forEach(r=>{
        const [sy,sm]=parseYearPiece(r['在位起']||r['start']||r['起']||'');
        const [ey,em]=parseYearPiece(r['在位止']||r['end']||r['止']||'');
        const startF=startAsFloat(sy,sm), endF=endAsFloat(ey,em);
        const rec={朝代:r['朝代']||'',姓名:r['姓名']||'',常用称呼:r['常用称呼']||'',在位起:startF,在位止:endF,sY:sy,sM:sm,eY:ey,eM:em,sheet:sn,idx:rowIndex++};
        if(rec.朝代 && rec.姓名 && startF!=null && endF!=null) rows.push(rec);
      });
    });
    // 读取年号表
    const nSheet = wb.Sheets['年号'] || wb.Sheets['nianhao'];
    eras = nSheet ? XLSX.utils.sheet_to_json(nSheet,{raw:true,defval:''}).map(r=>{
      const s=Number(r['公元起']), e=Number(r['公元止']);
      return { dynasty:String(r['朝代']||'').trim(), name:String(r['年号']||'').trim(), s:s, e:e }
    }).filter(d=>d.dynasty && d.name && Number.isFinite(d.s) && Number.isFinite(d.e) && d.e>=d.s) : [];

    const byDyn=new Map();
    rows.forEach(r=>{
      if(!byDyn.has(r.朝代)) byDyn.set(r.朝代,{min:r.在位起,max:r.在位止});
      const o=byDyn.get(r.朝代); o.min=Math.min(o.min,r.在位起); o.max=Math.max(o.max,r.在位止);
    });
    byDyn.forEach((v,k)=>dynRangeMap.set(k,{start:v.min,end:v.max}));
    rows.forEach(r=>dynSet.add(r.朝代));
    const sel=S('#dynSelect'); sel.innerHTML='<option value=\"\">选择一个朝代</option>';
    [...dynSet].sort((a,b)=>{const ra=dynRangeMap.get(a),rb=dynRangeMap.get(b);return (ra?ra.start:Infinity)-(rb?rb.start:Infinity)})
      .forEach(d=>{const o=document.createElement('option');o.value=d;o.textContent=d;sel.appendChild(o)});
    S('#status').textContent='加载完成' + (eras.length? ' · 年号可用' : '');
  }catch(e){ console.error(e); S('#status').textContent='加载失败：'+e.message }
}

function addDyn(){ const v=S('#dynSelect').value; if(!v || pickedDynasties.includes(v)) return;
  pickedDynasties.push(v); pickedDynasties.sort((a,b)=>{const ra=dynRangeMap.get(a),rb=dynRangeMap.get(b);return (ra?ra.start:Infinity)-(rb?rb.start:Infinity)}); renderChips(); draw(); }
function removeDyn(v){ pickedDynasties=pickedDynasties.filter(x=>x!==v); renderChips(); draw(); }
function renderChips(){
  const wrap=S('#chips'); wrap.innerHTML='';
  pickedDynasties.forEach(d=>{
    const chip=document.createElement('span'); chip.className='chip';
    const range=dynRangeMap.get(d);
    const txt=range?`（${range.start<0?`前${Math.abs(Math.trunc(range.start))}`:Math.trunc(range.start)} — ${range.end<0?`前${Math.abs(Math.trunc(range.end))}`:Math.trunc(range.end)}）`:'';
    chip.innerHTML=`<span class='dot' style='background:${hashColor(d)}'></span>${d}${txt}<button class='rm' title='移除'>×</button>`;
    chip.querySelector('.rm').addEventListener('click',()=>removeDyn(d));
    wrap.appendChild(chip);
  });
}
function parseInput(val){ const [y,m]=parseYearPiece(val); if(y==null) return null; return m==null?y:endAsFloat(y,m) }
function autoPickByRange(){ if(!S('#autoPick').checked) return; const s=customStart!=null?customStart:-Infinity; const e=customEnd!=null?customEnd:Infinity; const matches=[]; dynRangeMap.forEach((rng,dyn)=>{ if(rng.end>=s && rng.start<=e) matches.push(dyn) }); matches.sort((a,b)=>{ const ra=dynRangeMap.get(a),rb=dynRangeMap.get(b); return (ra?ra.start:Infinity)-(rb?rb.start:Infinity) }); pickedDynasties=matches; renderChips() }
function applyRange(){ customStart=S('#startYear').value?parseInput(S('#startYear').value):null; customEnd=S('#endYear').value?parseInput(S('#endYear').value):null; if(customStart!=null && customEnd!=null && customStart>customEnd) [customStart,customEnd]=[customEnd,customStart]; autoPickByRange(); draw(); const res=S('#result'); if(res&&res.style.display!=='none') res.scrollIntoView({behavior:'smooth',block:'start'}) }
function clearRange(){ customStart=customEnd=null; S('#startYear').value=''; S('#endYear').value=''; if(S('#autoPick').checked){ pickedDynasties=[]; renderChips() } draw() }

const tip=S('#tooltip'); function showTip(html,x,y){ tip.innerHTML=html; tip.style.left=x+'px'; tip.style.top=y+'px'; tip.classList.add('show') } function hideTip(){ tip.classList.remove('show') }

function draw(){
  const list=rows.filter(r=>pickedDynasties.includes(r.朝代));
  if(!list.length){ S('#result').style.display='none'; return }
  const groups={};
  list.forEach(r=>{
    if(customStart!=null && r.在位止<customStart) return;
    if(customEnd!=null && r.在位起>customEnd) return;
    (groups[r.朝代]??=[]).push(r)
  });
  const dyns=pickedDynasties.filter(d=>groups[d]);
  if(!dyns.length){ S('#result').style.display='none'; return }
  dyns.forEach(d=>groups[d].sort((a,b)=>(a.在位起-b.在位起)||(a.在位止-b.在位止)||(a.idx-b.idx)));
  const all=dyns.flatMap(d=>groups[d]);
  let minYear=Math.min(...all.map(r=>r.在位起)), maxYear=Math.max(...all.map(r=>r.在位止));
  if(customStart!=null) minYear=Math.max(minYear,customStart);
  if(customEnd!=null) maxYear=Math.min(maxYear,customEnd);
  const range=Math.max(1,maxYear-minYear);

  const wrap=S('#timeline-wrap');
  const W=Math.max(1100,wrap.clientWidth-2);
  const leftPad=200,rightPad=24,topPad=24,rowH=28,gap=8,groupGap=18;
  let rowsCount=0; dyns.forEach(d=>rowsCount+=groups[d].length);
  const H=topPad+dyns.length*24+rowsCount*(rowH+gap)+(dyns.length-1)*groupGap+80;
  const axisY=H-40;
  const scale=y=>leftPad+((y-minYear)/range)*(W-leftPad-rightPad);
  const svg=S('#timeline'); svg.setAttribute('width',W); svg.setAttribute('height',H); svg.innerHTML='';

  const gridLayer=document.createElementNS('http://www.w3.org/2000/svg','g'); gridLayer.setAttribute('id','gridLayer'); svg.appendChild(gridLayer);
  const barsLayer=document.createElementNS('http://www.w3.org/2000/svg','g'); barsLayer.setAttribute('id','barsLayer'); svg.appendChild(barsLayer);

  const step=niceStep(range);
  const startTick=Math.ceil(minYear/step)*step;
  if(S('#showGrid').checked){
    for(let t=startTick;t<=maxYear;t+=step){
      const x=scale(t);
      const vline=document.createElementNS('http://www.w3.org/2000/svg','line');
      vline.setAttribute('x1',x); vline.setAttribute('x2',x); vline.setAttribute('y1',topPad); vline.setAttribute('y2',axisY); vline.setAttribute('class','grid-v'); gridLayer.appendChild(vline);
    }
  }

  let cursorY=topPad;
  dyns.forEach(d=>{
    const headerH=22;
    const title=document.createElementNS('http://www.w3.org/2000/svg','text');
    title.setAttribute('x',12); title.setAttribute('y',cursorY+10); title.setAttribute('class','group-title');
    const rr=dynRangeMap.get(d);
    const rangeTxt=rr?`（${rr.start<0?`前${Math.abs(Math.trunc(rr.start))}`:Math.trunc(rr.start)} — ${rr.end<0?`前${Math.abs(Math.trunc(rr.end))}`:Math.trunc(rr.end)}）`:'';
    title.textContent=d+(rangeTxt?` ${rangeTxt}`:'');
    barsLayer.appendChild(title);
    cursorY+=headerH;

    groups[d].forEach((r,i)=>{
      const y=cursorY+i*(rowH+gap);
      if(S('#showGrid').checked){
        const hline=document.createElementNS('http://www.w3.org/2000/svg','line');
        hline.setAttribute('x1',leftPad); hline.setAttribute('x2',W-rightPad); hline.setAttribute('y1',y+rowH); hline.setAttribute('y2',y+rowH); hline.setAttribute('class','grid-h'); gridLayer.appendChild(hline);
      }
      const s=customStart!=null?clamp(r.在位起,customStart,Infinity):r.在位起;
      const e=customEnd!=null?clamp(r.在位止,-Infinity,customEnd):r.在位止;
      const x1=scale(s), x2=scale(e);
      const alias=r.常用称呼||r.姓名;

      const name=document.createElementNS('http://www.w3.org/2000/svg','text');
      name.setAttribute('x',leftPad-10); name.setAttribute('y',y+rowH*0.7);
      name.setAttribute('text-anchor','end'); name.setAttribute('class','label');
      name.textContent=alias===r.姓名?alias:`${alias} ${r.姓名}`; barsLayer.appendChild(name);

      const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x',Math.min(x1,x2)); rect.setAttribute('y',y); rect.setAttribute('width',Math.max(4,Math.abs(x2-x1))); rect.setAttribute('height',rowH); rect.setAttribute('rx',6);
      rect.setAttribute('fill',hashColor(d));
      rect.addEventListener('mousemove',ev=>{ showTip(`${alias===r.姓名?alias:`${alias} ${r.姓名}`}<br>${ymLabel(r.sY,r.sM)} — ${ymLabel(r.eY,r.eM)}`,ev.clientX,ev.clientY) });
      rect.addEventListener('mouseleave',hideTip);
      barsLayer.appendChild(rect);

      const outline=document.createElementNS('http://www.w3.org/2000/svg','rect');
      outline.setAttribute('x',Math.min(x1,x2)); outline.setAttribute('y',y); outline.setAttribute('width',Math.max(4,Math.abs(x2-x1))); outline.setAttribute('height',rowH); outline.setAttribute('rx',6); outline.setAttribute('class','bar-outline');
      barsLayer.appendChild(outline);

      // 年号切片（可选显示）
      if(S('#showEra').checked && eras.length){
        const rel = eras.filter(er => er.dynasty===d && er.e>=r.在位起 && er.s<=r.在位止).sort((a,b)=>a.s-b.s);
        rel.forEach(er=>{
          const sx = scale(Math.max(er.s, r.在位起, customStart??-Infinity));
          const ex = scale(Math.min(er.e, r.在位止, customEnd??Infinity));
          const w = Math.max(2, ex - sx);
          const ey = y + 4;
          const eh = rowH - 8;
          const eRect = document.createElementNS('http://www.w3.org/2000/svg','rect');
          eRect.setAttribute('x', sx); eRect.setAttribute('y', ey); eRect.setAttribute('width', w); eRect.setAttribute('height', eh); eRect.setAttribute('rx',3); eRect.setAttribute('class','era');
          eRect.addEventListener('mousemove', ev => { showTip(`<strong>${er.name}</strong>（${d}）<br/>${er.s} — ${er.e}`, ev.clientX, ev.clientY) });
          eRect.addEventListener('mouseleave', hideTip);
          barsLayer.appendChild(eRect);
          if (w > 44) {
            const t = document.createElementNS('http://www.w3.org/2000/svg','text');
            t.setAttribute('x', sx+4); t.setAttribute('y', ey+eh*0.68); t.setAttribute('class','label');
            t.textContent = er.name; barsLayer.appendChild(t);
          }
        });
      }
    });

    cursorY += groups[d].length*(rowH+gap)+groupGap;
  });

  const axisLine=document.createElementNS('http://www.w3.org/2000/svg','line');
  const H=svg.getAttribute('height'); const axisY=H-40;
  axisLine.setAttribute('x1',200); axisLine.setAttribute('x2',W-24); axisLine.setAttribute('y1',axisY); axisLine.setAttribute('y2',axisY); axisLine.setAttribute('class','axis');
  barsLayer.appendChild(axisLine);
  const step2=niceStep(range); const startTick2=Math.ceil(minYear/step2)*step2;
  for(let t=startTick2;t<=maxYear;t+=step2){
    const x=leftPad+((t-minYear)/range)*(W-leftPad-rightPad);
    const tick=document.createElementNS('http://www.w3.org/2000/svg','line');
    tick.setAttribute('x1',x); tick.setAttribute('x2',x); tick.setAttribute('y1',axisY); tick.setAttribute('y2',axisY+6); tick.setAttribute('class','axis'); barsLayer.appendChild(tick);
    const lbl=document.createElementNS('http://www.w3.org/2000/svg','text');
    lbl.setAttribute('x',x); lbl.setAttribute('y',axisY+18); lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('class','axis');
    lbl.textContent=t<0?`前${-t}`:`${t}`; barsLayer.appendChild(lbl);
  }
  S('#result').style.display='';
}

document.getElementById('btnAdd').addEventListener('click',addDyn);
document.getElementById('btnClear').addEventListener('click',()=>{pickedDynasties=[];renderChips();draw()});
document.getElementById('btnApplyRange').addEventListener('click',applyRange);
document.getElementById('btnClearRange').addEventListener('click',clearRange);
document.getElementById('showGrid').addEventListener('change',()=>draw());
document.getElementById('showEra').addEventListener('change',()=>draw());

// 加载
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadData);
} else {
  loadData();
}

document.getElementById('timeline-wrap').addEventListener('mouseleave',()=>{document.getElementById('tooltip').classList.remove('show')});
</script>
</body>
</html>
