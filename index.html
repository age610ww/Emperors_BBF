
<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>中国皇帝时间轴（智能年号显示版）</title>
<link rel="icon" href="data:,">
<style>
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;background:#fff;color:#111;}
.card{max-width:1280px;margin:16px auto;padding:16px;border:1px solid #e5e7eb;border-radius:16px;}
.row{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
select,input[type=number]{padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;}
input[type=range]{width:220px}
.btn{padding:10px 14px;border-radius:12px;border:1px solid #e5e7eb;background:#111;color:#fff;font-weight:600;cursor:pointer;}
.btn.secondary{background:transparent;color:#111;}
.status{margin-top:6px;color:#374151;font-size:13px;}
.status.err{color:#b91c1c}
.label{fill:#1f2937;font-size:12px;pointer-events:none}
.group-title{fill:#1f2937;font-size:13px;font-weight:700}
.axis text{fill:#9ca3af;font-size:12px}
.axis line{stroke:#9ca3af}
.grid-v{stroke:#e5e7eb;stroke-width:1;opacity:.8}
.grid-h{stroke:#f3f4f6;stroke-width:1;opacity:.9}
.bar-outline{stroke:rgba(0,0,0,.2);stroke-width:.6;fill:none}
.timeline-shell{display:grid;grid-template-columns:300px 1fr;gap:0}
.labels-col{position:sticky;left:0;background:#fff;border-right:1px solid #e5e7eb;z-index:5}
.scroll-col{overflow-x:auto}
svg{display:block;background:#fff}
#tip{position:fixed;display:none;background:#111;color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;pointer-events:none;z-index:10}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#f3f4f6;border:1.5px solid #e5e7eb;cursor:pointer;}
.chip .dot{width:10px;height:10px;border-radius:999px;}
.chip .rm{cursor:pointer;border:none;background:transparent;color:#2563eb;font-weight:700}
</style>
</head>
<body>
<header style="padding:24px 16px 0;max-width:1280px;margin:0 auto;"><h1>中国皇帝时间轴</h1></header>

<section class="card">
  <div class="row">
    <select id="dynSelect" style="min-width:260px"><option value="">加载中…</option></select>
    <button class="btn" id="btnAdd">添加朝代</button>
    <button class="btn secondary" id="btnClear">清空</button>
    <label><input id="autoPick" type="checkbox" checked> 自动选朝代</label>
    <label><input id="showGrid" type="checkbox" checked> 显示网格</label>
    <label><input id="showEra" type="checkbox" checked> 显示年号</label>
    <span>缩放</span><input id="zoom" type="range" min="1" max="4" step="0.1" value="1"><span id="zoomVal">1.0×</span>
  </div>
  <div class="chips" id="chips"></div>
  <div class="status" id="status">正在加载数据…</div>
</section>

<section class="card" id="result" style="display:none">
  <div class="timeline-shell">
    <div class="labels-col"><svg id="labelsSvg"></svg></div>
    <div class="scroll-col"><svg id="barsSvg"></svg></div>
  </div>
</section>

<div id="tip"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
(function(){
const XLSX_URL='emperors.xlsx';
function $(q,root){return (root||document).querySelector(q);}
function parseYearPiece(str){var s=String(str||'').trim();if(!s)return[null,null];var m=s.match(/^(-?\d+)(?:\.(\d{1,2}))?$/);return m?[parseInt(m[1],10),m[2]?parseInt(m[2],10):null]:[Number(s.replace(/[^-0-9.]/g,'')),null];}
function startAsFloat(y,m){if(y==null)return null;if(m==null)return y;var sign=y<0?-1:1;return y+sign*((m-1)/12);}
function endAsFloat(y,m){if(y==null)return null;if(m==null)return y;var sign=y<0?-1:1;return y+sign*(m/12);}
function clamp(n,a,b){return Math.max(a,Math.min(b,n));}
function lightenTowardWhite(hex,ratio){try{let c=hex.replace('#','');if(c.length===3){c=c.split('').map(x=>x+x).join('');}let r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16);let nr=Math.round(r+(255-r)*ratio),ng=Math.round(g+(255-g)*ratio),nb=Math.round(b+(255-b)*ratio);return '#'+nr.toString(16).padStart(2,'0')+ng.toString(16).padStart(2,'0')+nb.toString(16).padStart(2,'0');}catch(e){return hex;}}
function darken(hex,amt){try{var c=hex.replace('#','');if(c.length===3){c=c.split('').map(x=>x+x).join('');}var r=parseInt(c.substr(0,2),16),g=parseInt(c.substr(2,2),16),b=parseInt(c.substr(4,2),16);r=Math.max(0,Math.min(255,r+amt));g=Math.max(0,Math.min(255,g+amt));b=Math.max(0,Math.min(255,b+amt));return '#'+r.toString(16).padStart(2,'0')+g.toString(16).padStart(2,'0')+b.toString(16).padStart(2,'0');}catch(e){return hex;}}

var rows=[],dynSet={},dynRangeMap={},eras=[],picked=[],zoom=1;
const EMP_PALETTE=["#8b5cf6","#60a5fa","#22c55e","#f59e0b","#ef4444","#06b6d4","#a3e635","#d946ef","#10b981","#eab308","#3b82f6"];
const defEmp={},defEra={};
function eraFromEmp(emp){return lightenTowardWhite(emp,0.55);}
function assignDefaultForDynasty(d){if(defEmp[d])return;const emp=EMP_PALETTE[Object.keys(defEmp).length%EMP_PALETTE.length];defEmp[d]=emp;defEra[d]=eraFromEmp(emp);}

function loadData(){
 fetch(XLSX_URL,{cache:'no-store'}).then(r=>{if(!r.ok)throw new Error('无法加载 emperors.xlsx');return r.arrayBuffer();}).then(buf=>{
  var wb=XLSX.read(buf,{type:'array'});rows=[];dynSet={};dynRangeMap={};
  wb.SheetNames.forEach(sn=>{
    if(sn==='年号'||/^nianhao$/i.test(sn))return;
    var ws=wb.Sheets[sn];if(!ws)return;
    var json=XLSX.utils.sheet_to_json(ws,{raw:true,defval:''});
    json.forEach(r=>{
      var p1=parseYearPiece(r['在位起']||'');var p2=parseYearPiece(r['在位止']||'');
      var s=startAsFloat(p1[0],p1[1]),e=endAsFloat(p2[0],p2[1]);
      if(r['朝代']&&r['姓名']&&s!=null&&e!=null){rows.push({朝代:r['朝代'],姓名:r['姓名'],常用称呼:r['常用称呼']||'',在位起:s,在位止:e});dynSet[r['朝代']]=1;if(!dynRangeMap[r['朝代']])dynRangeMap[r['朝代']]={start:s,end:e};dynRangeMap[r['朝代']].start=Math.min(dynRangeMap[r['朝代']].start,s);dynRangeMap[r['朝代']].end=Math.max(dynRangeMap[r['朝代']].end,e);} });
  });
  var ns=wb.Sheets['年号']||wb.Sheets['nianhao'];
  eras=[];
  if(ns){XLSX.utils.sheet_to_json(ns,{raw:true,defval:''}).forEach(r=>{
    var s=Number(r['公元起']),e=Number(r['公元止']);
    var d=String(r['朝代']||'').trim();var nm=String(r['年号']||'').trim();var emp=String(r['姓名']||'').trim();
    if(d&&nm&&emp&&isFinite(s)&&isFinite(e)&&e>=s){eras.push({dynasty:d,name:nm,emperor:emp,s:s,e:e});}
  });}
  var list=Object.keys(dynSet).sort((a,b)=>dynRangeMap[a].start-dynRangeMap[b].start);
  var sel=$('#dynSelect');sel.innerHTML='<option value="">选择一个朝代</option>';list.forEach(d=>{var o=document.createElement('option');o.value=d;o.textContent=d;sel.appendChild(o);});
  $('#status').textContent='加载完成';
 }).catch(e=>{$('#status').textContent='加载失败：'+e.message;$('#status').classList.add('err');});
}

function draw(){
 var list=rows.filter(r=>picked.includes(r.朝代));
 if(!list.length){$('#result').style.display='none';return;}
 $('#result').style.display='';
 var groups={};list.forEach(r=>(groups[r.朝代]||(groups[r.朝代]=[])).push(r));
 var dyns=picked.filter(d=>groups[d]);if(!dyns.length)return;
 dyns.forEach(d=>groups[d].sort((a,b)=>a.在位起-b.在位起));
 var all=[];dyns.forEach(d=>all=all.concat(groups[d]));
 var minY=Math.min(...all.map(r=>r.在位起)),maxY=Math.max(...all.map(r=>r.在位止));
 var width=1400*zoom,labelsW=300,top=20,rowH=30,gap=10;
 var H=top+dyns.length*24+all.length*(rowH+gap)+60;
 var barsSvg=$('#barsSvg');barsSvg.setAttribute('width',width);barsSvg.setAttribute('height',H);barsSvg.innerHTML='';
 var labelsSvg=$('#labelsSvg');labelsSvg.setAttribute('width',labelsW);labelsSvg.setAttribute('height',H);labelsSvg.innerHTML='';
 function scale(y){return ((y-minY)/(maxY-minY))*(width-80)+40;}
 var cursorY=top;
 dyns.forEach(d=>{
   var t=document.createElementNS('http://www.w3.org/2000/svg','text');t.textContent=d; t.setAttribute('x',12);t.setAttribute('y',cursorY+12);t.setAttribute('class','group-title');labelsSvg.appendChild(t);cursorY+=20;
   var emperors=groups[d];var color=defEmp[d]||'#8b5cf6';var eraColor=defEra[d]||lightenTowardWhite(color,0.5);
   emperors.forEach((r,i)=>{
     var y=cursorY+i*(rowH+gap);
     var xs=scale(r.在位起),xe=scale(r.在位止);
     var w=xe-xs; if(w<1)w=1;
     var rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
     rect.setAttribute('x',xs);rect.setAttribute('y',y);rect.setAttribute('width',w);rect.setAttribute('height',rowH);rect.setAttribute('rx',8);rect.setAttribute('fill',color);
     barsSvg.appendChild(rect);
     var related=eras.filter(e=>e.dynasty===d&&e.emperor===r.姓名&&e.e>=r.在位起&&e.s<=r.在位止).sort((a,b)=>a.s-b.s);
     var next=xs;
     related.forEach(er=>{
       var sx=Math.max(scale(er.s),xs),ex=Math.min(scale(er.e),xe);
       if(sx<next)sx=next;
       var w2=ex-sx; if(w2<0)w2=0;
       var eRect=document.createElementNS('http://www.w3.org/2000/svg','rect');
       eRect.setAttribute('x',sx);eRect.setAttribute('y',y+5);eRect.setAttribute('width',w2);eRect.setAttribute('height',rowH-10);eRect.setAttribute('rx',6);eRect.setAttribute('fill',eraColor);eRect.setAttribute('stroke',darken(eraColor,-40));barsSvg.appendChild(eRect);
       // decide if show text
       var fontSize=12*zoom;var textWidth=er.name.length*fontSize*0.6;
       if(textWidth <= w2*0.9){
         var t2=document.createElementNS('http://www.w3.org/2000/svg','text');
         t2.textContent=er.name;t2.setAttribute('x',(sx+ex)/2);t2.setAttribute('y',y+rowH/2);t2.setAttribute('text-anchor','middle');t2.setAttribute('dominant-baseline','central');t2.setAttribute('class','label');t2.setAttribute('font-size',fontSize);barsSvg.appendChild(t2);
       }
       next=ex;
     });
   });
   cursorY+=emperors.length*(rowH+gap)+20;
 });
}

$('#btnAdd').onclick=function(){var v=$('#dynSelect').value;if(!v)return;if(picked.includes(v))return;assignDefaultForDynasty(v);picked.push(v);draw();};
$('#btnClear').onclick=function(){picked=[];draw();};
$('#zoom').oninput=function(e){zoom=parseFloat(e.target.value)||1;$('#zoomVal').textContent=zoom.toFixed(1)+'×';draw();};
loadData();
})();
</script>
</body>
</html>
