
<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>中国皇帝在位与年号（整合版）</title>
  <style>
    :root{
      --bg:#0f1221; --panel:#0f1429; --grid:#23263a; --fg:#e8edf2; --muted:#9aa3b2;
      --accent:#7aa2f7; --bar:#4cc9f0; --era:#f9c74f; --era2:#90be6d;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;}
    header{padding:18px 14px 8px;border-bottom:1px solid var(--grid);display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end}
    h1{font-size:20px;margin:0 12px 0 0}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    label{opacity:.95}
    select,input[type="text"],button{background:#151a31;border:1px solid var(--grid);color:var(--fg);
      padding:6px 10px;border-radius:10px;outline:none}
    button{cursor:pointer}
    #wrap{max-width:1280px;margin:0 auto;padding:12px 10px 36px}
    .legend{display:flex;gap:16px;color:var(--muted);margin:10px 2px}
    .swatch{width:16px;height:8px;border-radius:3px;display:inline-block;margin-right:6px}
    .chart{position:relative;overflow:auto;background:var(--panel);border:1px solid var(--grid);border-radius:14px}
    .axis path,.axis line{stroke:var(--grid)}
    .tick text{fill:var(--muted);font-size:11px}
    .rowLabel{fill:var(--muted);font-size:12px}
    .emp{rx:6;ry:6;shape-rendering:geometricPrecision}
    .era{rx:3;ry:3;shape-rendering:geometricPrecision}
    .empLabel{font-size:12px;fill:#0a0e1f;pointer-events:none}
    .eraLabel{font-size:10px;fill:#0a0e1f;pointer-events:none}
    .tooltip{position:absolute;pointer-events:none;background:#0b0f22;color:var(--fg);border:1px solid var(--grid);
      padding:8px 10px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);opacity:0;transition:opacity .12s;white-space:nowrap}
    .notice{color:var(--muted);font-size:13px;margin:8px 0}
    a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>
<header>
  <h1>皇帝在位 × 年号（整合视图）</h1>
  <div class="controls">
    <label>筛选朝代：
      <select id="dynFilter"><option value="">全部</option></select>
    </label>
    <label>搜索皇帝：
      <input id="empSearch" type="text" placeholder="输入姓名/常用称呼 回车" />
    </label>
    <label>显示：
      <select id="displayMode">
        <option value="bar">仅在位</option>
        <option value="era">在位 + 年号切片</option>
        <option value="eraOnly">仅年号（按朝代）</option>
      </select>
    </label>
    <label>年份范围：
      <select id="rangePreset">
        <option value="auto">自动</option>
        <option value="xijin">两晋</option>
        <option value="han3">两汉与三国</option>
        <option value="16g">十六国</option>
        <option value="custom">自定义</option>
      </select>
    </label>
    <span id="customRange" style="display:none">
      <input id="startYear" type="number" placeholder="起年" style="width:90px" />
      <input id="endYear" type="number" placeholder="止年" style="width:90px" />
      <button id="applyRange">应用</button>
    </span>
  </div>
  <div class="notice">放置 <code>index.html</code> 与 <code>emperors.xlsx</code> 于同一目录即可。会读取所有皇帝工作表以及可选的 <strong>“年号”</strong> 工作表（表头：朝代/年号/公元起/公元止）。</div>
</header>
<div id="wrap">
  <div class="legend">
    <span><span class="swatch" style="background:var(--bar)"></span>皇帝在位</span>
    <span><span class="swatch" style="background:var(--era)"></span>年号</span>
  </div>
  <div id="chart" class="chart"></div>
  <div id="status" class="notice"></div>
</div>

<!-- deps -->
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
const $ = sel => document.querySelector(sel);

function groupBy(arr, key){ return arr.reduce((acc,cur)=>{(acc[cur[key]]||(acc[cur[key]]=[])).push(cur);return acc},{}); }
function extent(arr){ return [Math.min(...arr), Math.max(...arr)]; }

async function loadWorkbook(){
  const resp = await fetch('emperors.xlsx');
  if(!resp.ok) throw new Error('无法读取 emperors.xlsx');
  const ab = await resp.arrayBuffer();
  const wb = XLSX.read(ab, {type:'array'});
  return wb;
}

function parseEmperors(wb){
  const emperorSheets = wb.SheetNames.filter(n => n !== '年号' && !/^nianhao$/i.test(n));
  const rows = [];
  emperorSheets.forEach(name=>{
    const arr = XLSX.utils.sheet_to_json(wb.Sheets[name], {defval:''});
    arr.forEach(r=>{
      const d = {
        sheet: name,
        dynasty: String(r['朝代']||'').trim(),
        name: String(r['姓名']||r['皇帝']||'').trim(),
        alias: String(r['常用称呼']||'').trim(),
        start: Number(r['在位起']),
        end: Number(r['在位止'])
      };
      if(d.dynasty && d.name && Number.isFinite(d.start) && Number.isFinite(d.end) && d.end >= d.start){
        rows.push(d);
      }
    });
  });
  return rows;
}

function parseEras(wb){
  const sheet = wb.Sheets['年号'] || wb.Sheets['nianhao'];
  if(!sheet) return [];
  const arr = XLSX.utils.sheet_to_json(sheet, {defval:''});
  return arr.map(r=>({
    dynasty: String(r['朝代']||'').trim(),
    name: String(r['年号']||'').trim(),
    s: Number(r['公元起']),
    e: Number(r['公元止'])
  })).filter(d=>d.dynasty && d.name && Number.isFinite(d.s) && Number.isFinite(d.e) && d.e >= d.s);
}

function draw(emperors, eras){
  const dynSet = [...new Set(emperors.map(d=>d.dynasty))].sort();
  const dynSel = $('#dynFilter');
  dynSet.forEach(d=>{ const o=document.createElement('option'); o.value=d; o.textContent=d; dynSel.appendChild(o); });

  const state = {
    dyn: '',
    keyword: '',
    mode: 'bar',
    start: Math.min(...emperors.map(d=>d.start), ...(eras.length?[eras[0].s]:[Infinity])),
    end: Math.max(...emperors.map(d=>d.end), ...(eras.length?[eras[eras.length-1].e]:[-Infinity]))
  };

  $('#empSearch').addEventListener('keydown', e=>{ if(e.key==='Enter'){ state.keyword = e.target.value.trim(); render(); }});
  $('#dynFilter').addEventListener('change', e=>{ state.dyn = e.target.value; render(); });
  $('#displayMode').addEventListener('change', e=>{ state.mode = e.target.value; render(); });
  $('#rangePreset').addEventListener('change', e=>{
    const v = e.target.value;
    const totalMin = Math.min(...emperors.map(d=>d.start), ...(eras.length?eras.map(e=>e.s):[Infinity]));
    const totalMax = Math.max(...emperors.map(d=>d.end), ...(eras.length?eras.map(e=>e.e):[-Infinity]));
    if(v==='custom'){ $('#customRange').style.display='inline-flex'; return; } else { $('#customRange').style.display='none'; }
    if(v==='xijin'){ state.start = 260; state.end = 425; }
    else if(v==='han3'){ state.start = -210; state.end = 300; }
    else if(v==='16g'){ state.start = 300; state.end = 440; }
    else { state.start = totalMin; state.end = totalMax; }
    render();
  });
  $('#applyRange').addEventListener('click', ()=>{
    const s = Number($('#startYear').value), e = Number($('#endYear').value);
    if(Number.isFinite(s) && Number.isFinite(e) && e >= s){ state.start=s; state.end=e; render(); }
  });

  const chart = d3.select('#chart');
  const tooltip = d3.select('body').append('div').attr('class','tooltip');

  function filteredData(){
    let arr = emperors.slice();
    if(state.dyn) arr = arr.filter(d=>d.dynasty===state.dyn);
    if(state.keyword){
      const kw = state.keyword.toLowerCase();
      arr = arr.filter(d=> d.name.toLowerCase().includes(kw) || d.alias.toLowerCase().includes(kw));
    }
    arr = arr.filter(d=> d.end >= state.start && d.start <= state.end);
    arr.sort((a,b)=> a.start-b.start || a.end-b.end);
    return arr;
  }

  function render(){
    const data = filteredData();
    const dyns = groupBy(data,'dynasty');
    const dynKeys = Object.keys(dyns);
    const [minY, maxY] = [state.start, state.end];

    const pad = 28, rowH = 26, gap = 10, leftW = 130;
    const width = Math.max(980, window.innerWidth - 40);
    const height = pad + 20 + dynKeys.reduce((h,dy)=> h + (dyns[dy].length*(rowH+6) + 16), 0) + 20;

    chart.html("");
    const svg = chart.append('svg').attr('width', width).attr('height', height);

    const x = d3.scaleLinear().domain([minY, maxY]).range([leftW+8, width-16]);
    const xAxis = d3.axisTop(x).ticks(Math.min(12, Math.max(6, Math.floor((maxY-minY)/30))));
    svg.append('g').attr('class','axis').attr('transform',`translate(0,${pad})`).call(xAxis);

    let y = pad + 24;

    dynKeys.forEach(dy=>{
      // 朝代标题
      svg.append('text').attr('class','rowLabel').attr('x',10).attr('y',y-6).text(dy);

      // 皇帝条
      dyns[dy].forEach((em,i)=>{
        const yRow = y + i*(rowH+6);
        const g = svg.append('g');
        const x1 = x(Math.max(em.start, minY));
        const x2 = x(Math.min(em.end, maxY));
        const w = Math.max(2, x2-x1);

        if(state.mode!=='eraOnly'){
          g.append('rect').attr('class','emp')
           .attr('x',x1).attr('y',yRow)
           .attr('width',w).attr('height',rowH)
           .attr('fill','var(--bar)').attr('opacity',0.9)
           .on('mousemove',(ev)=>{
             tooltip.style('opacity',1).style('left',(ev.pageX+12)+'px').style('top',(ev.pageY+12)+'px')
               .html(`<strong>${em.name}${em.alias?('（'+em.alias+'）'):''}</strong>（${dy}）<br/>在位：${em.start} – ${em.end}`);
           })
           .on('mouseleave',()=> tooltip.style('opacity',0));
          if(w>60){
            g.append('text').attr('class','empLabel').attr('x',x1+6).attr('y',yRow+rowH*0.68).text(em.alias||em.name);
          }
        }

        // 年号切片（仅当存在）
        if(state.mode!=='bar' && eras.length){
          const rel = eras.filter(er => er.dynasty===dy && er.e >= em.start && er.s <= em.end)
                          .sort((a,b)=> a.s-b.s);
          rel.forEach(er=>{
            const sx = x(Math.max(er.s, em.start, minY));
            const ex = x(Math.min(er.e, em.end, maxY));
            const ew = Math.max(2, ex - sx);
            const ey = yRow + (state.mode==='eraOnly'? 0 : 4);
            const eh = state.mode==='eraOnly'? rowH : (rowH-8);
            g.append('rect').attr('class','era')
              .attr('x',sx).attr('y',ey).attr('width',ew).attr('height',eh)
              .attr('fill','var(--era)').attr('opacity',0.95)
              .on('mousemove',(ev)=>{
                tooltip.style('opacity',1).style('left',(ev.pageX+12)+'px').style('top',(ev.pageY+12)+'px')
                  .html(`<strong>${er.name}</strong>（${dy}）<br/>${er.s} – ${er.e}`);
              })
              .on('mouseleave',()=> tooltip.style('opacity',0));
            if(ew>46){
              g.append('text').attr('class','eraLabel').attr('x',sx+4).attr('y',ey+eh*0.68).text(er.name);
            }
          });
        }

        // 左侧皇帝标签
        svg.append('text').attr('class','rowLabel').attr('x',leftW-8).attr('y',yRow+rowH*0.68).attr('text-anchor','end')
          .text(em.alias||em.name);
      });

      y += dyns[dy].length*(rowH+6) + 16;
    });

    $('#status').textContent = `显示 ${data.length} 位皇帝 · 年号 ${eras.length? '可用' : '未提供'} · 范围 ${Math.floor(minY)}–${Math.ceil(maxY)}`;
  }

  render();
  window.addEventListener('resize', ()=> draw(emperors, eras)); // 简单处理：窗口变化重新绘制
}

(async function(){
  try{
    const wb = await loadWorkbook();
    const emperors = parseEmperors(wb);
    const eras = parseEras(wb);
    draw(emperors, eras);
  }catch(err){
    console.error(err);
    document.querySelector('#chart').innerHTML = `<div style="padding:20px;color:#9aa3b2">加载失败：${err.message}</div>`;
  }
})();
</script>
</body>
</html>
